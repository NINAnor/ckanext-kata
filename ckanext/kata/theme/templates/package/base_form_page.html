{% extends "package/base.html" %}

{% import 'macros/form.html' as form %}
{% import 'macros/kata_form.html' as kataform %}

{% set user = c.userobj %}

{% set data = data or pkg or {} %}
{% set errors = errors or {} %}

{# From both package_basic_fields.html #}
{% set dataset_is_draft = data.get('state', 'draft').startswith('draft') or data.get('state', 'none') ==  'none' %}
{% set dataset_has_organization = data.owner_org or data.group_id %}
{% set organizations_available = h.organizations_available('create_dataset') %}
{% set user_is_sysadmin = h.check_access('sysadmin') %}
{% set show_organizations_selector = organizations_available and (user_is_sysadmin or dataset_is_draft) %}
{% set show_visibility_selector = dataset_has_organization or (organizations_available and (user_is_sysadmin or dataset_is_draft)) %}

{% set agent_index = h.create_loop_index() %}

{% set action = c.form_action or '' %}


{# ######################### #}

{% block primary %}

{# This provides a full page that renders a form for adding a dataset. It can
then itself be extended to add/remove blocks of functionality. #}
<form class="dataset-form" method="post" action="{{ action }}" data-module="basic-form"
      xmlns="http://www.w3.org/1999/html">

{#
  _ckan_phase was removed when integrating the ONKI selector
  Its existence lead to inconsistent functionalities when adding a new dataset
  or editing an old one. The problematic function can be found from:
  package._save_edit, tag_string lines within if '_ckan_phase'
  Though, the quick fix causes some problems, eg. the partial update brakes
 #}
  <input type="hidden" name="_ckan_phase" value="" />
  {# pkg_name used in 3 stage edit #}
  <input type="hidden" name="pkg_name" value="{{ data.id }}" />
  {% block errors %}{{ kataform.kataerrors(error_summary, h) }}{% endblock %}

<div class="module-content tab-content active">

{#% snippet 'package/snippets/info.html', pkg=pkg, action='package_edit' %#}
    {% if errors %}
      <div data-module="kata-notification-tools" class="floating-error" id="kata-error-window">
        <i class="icon-info-sign">&nbsp;</i>{{ _('You have errors in your metadata. Please, make the requested corrections.') }}
      </div>
    {% endif %}

  <ul class="unstyled nav nav-simple">
    <li class="nav-btn"><a href="#TODO" class="btn disabled">{{ _("Upload XML") }}</a></li>
    {% if pkg and h.check_access('package_update', {'id':pkg.id }) %}
      {% if h.dataset_is_valid(pkg) %}
         <li class="nav-btn"><a href="{{ h.url_for(controller='package', action='new_resource', id=pkg.name)  }}" class="btn{% if action == 'resource_new' %} disabled{% endif %}"><i class="icon-plus"></i> {{ _('Add new supplement') }}</a></li>
      {% endif %}
    {% endif %}
  </ul>

    <ul class="nav nav-tabs kata-dataset-tabs">
        <li class="active"><a href="#basic-tab" data-toggle="tab">{{ _('Basic metadata') }}</a></li>
        <li><a href="#agents-tab" data-toggle="tab">{{ _('Agents') }}</a></li>
        <li><a href="#licence-tab" data-toggle="tab">{{ _('Licence and availability') }}</a></li>
        <li><a href="#additional-tab" data-toggle="tab">{{ _('Additional information') }}</a></li>
        <li><a href="#identifier-tab" data-toggle="tab">{{ _('Identifiers') }}</a></li>
        <li><a href="#discipline-tab" data-toggle="tab">{{ _('Discipline specific') }}</a></li>
    </ul>
    <div id="basic-tab" class="tab-pane active">
      {% snippet 'package/snippets/package_basic_information.html', data=data, errors=errors, licences=licences, groups_available=groups_available, roles=roles, version_PID=version_PID, lastmod=lastmod, user=user, agent_index=agent_index %}
    </div>
    <div id="agents-tab" class="tab-pane">
      {% snippet 'package/snippets/package_actors.html', data=data, errors=errors, licences=licences, groups_available=groups_available, roles=roles, version_PID=version_PID, lastmod=lastmod, user=user, agent_index=agent_index %}
    </div>
    <div id="licence-tab" class="tab-pane">
      {% snippet 'package/snippets/package_usage_info.html', data=data, errors=errors, licences=licences, groups_available=groups_available, roles=roles, version_PID=version_PID, lastmod=lastmod, user=user %}
    </div>
    <div id="additional-tab" class="tab-pane">
      {% snippet 'package/snippets/recommended_form.html', data=data, errors=errors, error_summary=error_summary, include_metadata=false, pkg_name=pkg_name %}
    </div>
    <div id="identifier-tab" class="tab-pane">
      {% snippet 'package/snippets/package_identification_info.html', data=data, errors=errors, licences=licences, groups_available=groups_available, roles=roles, version_PID=version_PID, lastmod=lastmod, user=user %}
    </div>
    <div id="discipline-tab" class="tab-pane">
      <p>Discipline specific stuff will be here</p>
    </div>

    {% snippet 'package/snippets/package_terms_of_use.html' %}

    <!-- Tab paginator -->
    <div class="tab-paginator" data-module="kata-tab-paginator">
      <div class="btn-group" role="group">
        <button type="button" class="btn nofocus" id="prev-tab" ><span class="icon-chevron-left" ></span></button>
        <div id="tab-indicator" class="" hidden="true""></div>
        <button type="button" class="btn nofocus" id="next-tab"><span class="icon-chevron-right" ></span></button>
      </div>
    </div>

    <input type="hidden" value="{{ agent_index.index }}" id="agent-index" />
    <input type="hidden" value="True" id="private" name="private"/>

    {% block form_actions %}
        <div class="form-actions">
            {% block delete_button %}
                {#% if h.check_access('package_delete', {'id': data.id}) %#}
                {#% set locale = h.dump_json({'content': _('Are you sure you want to delete this dataset?')}) %#}
                {# <a class="btn btn-danger pull-left" href="{% url_for controller='package', action='delete', id=data.id %}" data-module="confirm-action" data-module-i18n="{{ locale }}">{% block delete_button_text %}{{ _('Delete') }}{% endblock %}</a> #}
                {#% endif %#}
            {% endblock %}
            {% block cancel_button %}
                <a class="btn" href="">{% block cancel_button_text %}{{ _('Cancel') }}{% endblock %}</a>
            {% endblock %}
            <button class="btn btn-primary" type="submit" value="finish" name="save">{% block save_button_text %}{{ _('Save') }}{% endblock %}</button>

            <button class="btn btn-primary" type="submit" value="finish" name="save" data-module="kata-save-tools" disabled="disabled">{% block save_and_publish_button_text %}{{ _('Save and publish') }}{% endblock %}</button>
        </div>
    {% endblock %}

</div>
</form>
{% endblock %}