{% import 'macros/form.html' as form %}
{% import 'macros/kata_form.html' as kata_form %}

<section class="module">
<h2 class="module-heading">{{ _('Required information') }}</h2>
<div class="module-content">
<input type="hidden" name="name" value="{% if data.name %}{{data.name}}{% endif %}" />
{% call form.input_block("titles", _('Titles') , error=errors.title, control_classes=["kata-multi-padding"], label_classes=["kata-multi-label"]) %}
	<div data-module="custom-fields-kata" data-module-id="lastlang" id="lastlang">
	
	{% set titles = [] %}
	
	{% if data.langtitles %}
		{% for title, lang in data.langtitles %}
			{% do titles.append((title, lang)) %}
		{% endfor %}
	{% else %}
		{% for title in data.title %}
			{% if title.value %}
				{% do titles.append((title.value, title.lang)) %}
			{% endif %}
		{% endfor %}
	{% endif%}
	
	{% if titles|length == 0 %}	
		{% for extra in range(1,2) %}
			{% do titles.append(('', '')) %}
		{% endfor %}
	{% endif%}

	{# Render title fields #}
	{% for title, lang in titles %}
		{% set index = loop.index0 %}
		{% call form.input('title__' ~ index ~ '__value', id='title__' ~ index ~ '__value_id', label=_('Title'), placeholder='', value=title.value, error=errors.title, classes=['control-group control-custom'], label_classes=['control-label kata-input-comp'], control_classes=['controls editor'], attrs={'class': "kata-medium-input"}) %}
			{% if index == 0 %}
				{{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type an informative title for the research data. Choose the title\'s language from the language menu. You can add several titles in different languages using the \'+\' button. If you leave an added title field empty it is discarded but, note that the first title field must have a value.')) }}
			{% endif %} 
			
			<label class="control-label kata-input-comp" for="title__{{index}}__lang_id">{{ _('Language') }}</label>
			<div class="controls kata-input-comp">
				<select name="title__{{index}}__lang">
					{% snippet 'package/snippets/languages.html', selected=lang.value %}
				</select>
				{% if index == 0 %}
					{{ kata_form.plusbutton(onclick="$(\'#lbtn__" ~ index ~ "__value_id\').change();") }}
				{% endif %} 
				
				{#% if title.value %#}
					<input style="display: none;" type="checkbox" id="lbtn__{{index}}__value_id" name="lbtn__{{index}}__value" class="btn btn-danger icon-plus-sign checkbox"/>
				{#% endif %#}
			</div>
		{% endcall %}
	{% endfor %}
	
	</div>
{% endcall %}

{% call form.input_block("author", _("Authors and organizations"), error=errors.author or errors.organization, control_classes=["kata-auth-padding"], label_classes=["kata-auth-label"]) %}
	<div data-module="custom-fields-kata" data-module-id="orgauths" id="orgauths">
	
	{% set authors = [] %}
	
	{% if data.orgauths %}
		{% for auth, org in data.orgauths %}
			{% do authors.append((auth, org)) %}
		{% endfor %}
	{% else %}
		{% if len(data.author) and len(data.organization) %}
			{% set orgauths = zip(data.author, data.organization) %}
		{% else %}
			{% if not len(data.author) %}
				{% set orgauths = zip(range(len(data.organization)), data.organization) %}
			{% elif not len(data.organization) %}
				{% set orgauths = zip(data.author, range(len(data.author)) ) %}
			{% endif %}
		{% endif %}
		{% for auth, org in orgauths %}
			{% do authors.append((auth, org)) %}
		{% endfor %}
	{% endif %}
	
	{% if authors|length == 0 %}	
		{% for extra in range(1, 2) %}
			{% do authors.append(('', '')) %}
		{% endfor %}
	{% endif %}
	
	{# Render author and organisation fields #}
	{% for author, org in authors %}
	
		{% set index = loop.index0 %}
		
			<div class="control-group control-custom">
			<label class="control-label kata-input-comp" for="author__{{ index }}__id">{{ _('Author') }}</label>
				<div class="controls editor">
					<input class="kata-medium-input" type="text" placeholder="{{Â _('http://orcid.org/ or name') }}" id="author__{{ index }}__value_id" name="author__{{ index }}__value" value="{{ author.value }}" />
					{% if index == 0 %}
						{{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type names of authors and organisations to the corresponding fields, one author per a field pair. You can add more fields for additional authors by pressing the \'+\' button. If you leave and added title field empty, it is discarded, but note that the first author/organisation field pair must have values.<br /><br />Author can be a name or an identifier URL, like an orcid identifier.')) }}
					{% endif %}
				</div>
			<label class="control-label kata-input-comp" for="organization__{{ index }}__id">{{ _('Organisation') }}</label>
				<div class="controls editor" style="margin-top: 5px;">
				<input class="kata-medium-input" type="text" id="organization__{{ index }}__value_id" name="organization__{{ index }}__value" value="{{ org.value }}" />
				{% if index == 0 %}
					{{ kata_form.plusbutton(onclick="$(\'#obtn__" ~ index ~ "__value_id\').change();") }}
				{% endif %}
				<input style="display: none;" type="checkbox" id="obtn__{{index}}__value_id" name="obtn__{{index}}__value" class="btn btn-danger icon-plus-sign checkbox"/>
				</div>
			</div>
	  {% endfor %}
	</div>
{% endcall %}

{% set tag_attrs = {'data-module': 'autocomplete', 'data-module-tags': '', 'data-module-source': '/api/2/util/tag/autocomplete?incomplete=?', 'class': "kata-medium-input"} %}

{% call form.input('tag_string', id='field-tags', label=_('Keywords'), placeholder=_('eg. economy, mental health, government'), value=data.tag_string, error=errors.tag_string, classes=['control-medium'], label_classes=['control-label'], attrs=tag_attrs) %}
	{{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Keywords are a set of words describing the subject and content of the data. Start typing to the keywords field. You will get suggestions from an ontology, from which you can select a word by clicking it or first selecting it and then pressing the enter key. You can also add custom keywords by typing the word you want and accepting it with the enter key. Remove an added keyword from the \'x\' button next to the keyword.')) }}
{% endcall %}

<input type="checkbox" style="top: 0px;" name="langdis" onchange="KATA.checkLang('#language')" {% if data.langdis == 'False' and data.langdis %}checked value="False"{% else %}value="True"{% endif %}>{{ _('This dataset does not have a language') }}</input>
<div id="langdiv" {% if data.langdis == 'False' and data.langdis %} style="display: none" {% endif %}>
{% call form.input('language', label=_('Languages'), id='language', placeholder=_('en, fi, sv ...'), value=data.language, error=errors.language, classes=['control-medium'], control_classes=["controls editor"], label_classes=['control-label'], attrs={'class': "kata-medium-input"}) %}
	{{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type a comma separated list of languages used in your research material, for example \"en, fi, sv\".')) }}
{% endcall %}
</div>
</div>
</section>

<section class="module">
<h2 class="module-heading">{{ _('Actors and roles') }}</h2>
	<div class="module-content">
		<h3 class="module-heading">{{ _('Distributor / publisher contact information') }}</h3>
		<div class="module-content">
			{% set contact_name = data.publisher if data.publisher else user.fullname %}
			{% set contact_email = data.maintainer_email if data.maintainer_email else user.email %}

			{% call form.input('publisher', label=_('Name'), id='contact_name', placeholder=_('John Doe'), value=contact_name, error=errors.publisher, classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
				{{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type the name of the publisher. Publisher is someone that can be contacted if more information about the data is required or the person responsible for the data needs to be contacted. By default, the system suggests you to be this person.')) }} 
			{% endcall %}			

			{% call form.input('phone', label=_('Phone'), id='phone', placeholder=_('+35844122123'), value=data.phone, error=errors.phone, classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
				{{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type the contact phone number. The phone number must be in form \"+35812341234\".')) }} 
			{% endcall %}			

			{% call form.input('maintainer_email', label=_('Email'), id='maintainer_email', placeholder=_('john.doe@example.com'), value=contact_email, error=errors.maintainer_email, classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
				{{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type the contact e-mail address.')) }} 
			{% endcall %}			

			{% call form.input('contactURL', label=_('Homepage'), id='contactURL', placeholder=_('http://johndoe.com/contact'), value=data.contactURL, error=errors.contactURL, classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
				{{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type a valid web address to you web page. In case you don\'t have one, you could for example give an address to your research group\'s site or any site that could make it possible to contact the origin of the dataset in case of need.')) }} 
			{% endcall %}						
		</div>
		<h3 class="module-heading">{{ _('Project that produced this dataset') }}</h3>
		<input type="checkbox" style="top: 0px;" name="projdis" onchange="$('#projdiv').toggle()" {% if data.projdis != 'False' and data.projdis %}checked value="False"{% endif %}value="True">{{ _('This dataset was not produced in a project.') }}</input>
		<div class="module-content" id="projdiv" {% if data.projdis != 'False' and data.projdis %}style="display: none;"{% endif %}>
			{% call form.input('project_name', label=_('Name'), id='project_name', placeholder=_('my project'), value=data.project_name, error=errors.project_name, classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
				{{ kata_form.tooltip(tooltip=_('Field is compulsory if checkbox \"This dataset was not produced in a project.\" is unchecked.<br /><br />Type the project\'s name.')) }} 
			{% endcall %}

			{% call form.input('funder', label=_('Funder'), id='funder', placeholder=_('my funder'), value=data.funder, error=errors.funder, classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
				{{ kata_form.tooltip(tooltip=_('Field is compulsory if checkbox \"This dataset was not produced in a project.\" is unchecked.<br /><br />Type the project funder\'s name.')) }} 
			{% endcall %}
									
			{% call form.input('project_funding', label=_('Funding id'), id='project_funding', placeholder=_('1234'), value=data.project_funding, error=errors.project_funding, classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
				{{ kata_form.tooltip(tooltip=_('Field is compulsory if checkbox \"This dataset was not produced in a project.\" is unchecked.<br /><br />Type the project\'s funding id.')) }} 
			{% endcall %}

			{% call form.input('project_homepage', label=_('Homepage'), id='project_homepage', placeholder=_('http://myproject'), value=data.project_homepage, error=errors.project_homepage, classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
				{{ kata_form.tooltip(tooltip=_('Field is compulsory if checkbox \"This dataset was not produced in a project.\" is unchecked.<br /><br />Type the project\'s homepage')) }} 
			{% endcall %}
		</div>
		<h3 class="module-heading">{{ _('Owner information')}}</h3>
		<div class="module-content">
			{% call form.input('owner', label=_('Owner identity'), id="owner", placeholder=_('identification URL or name'), value=data.owner, error=errors.owner, classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
				{{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type the dataset owner\'s name or an identifier, for example and orcid identifier.')) }} 
			{% endcall %}						
		</div>
</section>
{# if we have a default group then this wants remembering #}
{% if data.group_id %}
  <input type="hidden" name="groups__0__id" value="{{ data.group_id }}" />
{% endif %}

<section class="module">
<h2 class="module-heading">{{ _('Identification information') }}</h2>
<div class="module-content">
{% call form.input('versionPID', id='field-pid', label=_('Permanent Identifier'), placeholder=_('will be automatically generated if empty'), value=data.versionPID, error=errors.versionPID, classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
	{{ kata_form.tooltip(tooltip=_('Field is compulsory but automatically generated if left empty.<br /><br />PID is a permanent, unique, identifier of the data, preferrably a URI. You can add your own identifier or use one generated by the service. <br /><br />The automatically generated PID is an URN identifier from the national library of Finland, of form \"urn:nbn:fi:csc-kata[unique number]\". Visit http://www.nationallibrary.fi/index.html for more information.')) }}
{% endcall %}						
{% call form.input_block("date", _('Modification date'), error=errors.version, control_classes=["kata-label-pluspad"], label_classes=['kata-input-comp']) %}
	<div class="control-group control-custom">
		<div data-module="dateselect-simple-kata">
			<input type="text" readonly id="last_modified" name="version" value="{{data.version}}" />
			{{ kata_form.tooltip(tooltip=_('Field is compulsory but an automatically generated date is provided.<br /><br />The modification date tells when the data has last been modified. Click the field to open a calendar tool to choose the modification date and time for this dataset. Accept and insert the date to the field by pressing the Done button. By default, the time zone is Z (Zulu Time Zone), which corresponds the UTC time zone.<br /><br />Note that this tool requires javascript to be enabled in the browser.')) }}
		</div>
	</div>
{% endcall %}
</div>
</section>

<section class="module">
<h2 class="module-heading">{{ _('Usage information') }}</h2>
<div class="module-content">
	<p>
		{{ _('Dataset is available for use:') }}
	</p>
	<div class="control-group ">
		<div class="controls ">
			<input type="radio" name="access" id="form" value="form" style="top: 0px" onclick="KATA.toggleAccess(this)" {% if data.access == 'form'%}checked{% endif %} >{{ _('with data access application') }}</input><br />
			<div id="accessDiv" {% if not data.accessRights and not data.access == 'form' %}style="display:none"{% endif%}>
				{{ form.input('accessRights', label=_('Web address of access application'), id='accessRights', placeholder=_('http://remsid/'), value=data.accessRights, error=errors.accessRights, classes=['control-medium'], control_classes=["kata-label-pluspad"], label_classes=['kata-input-comp'])}}
				{{ form.checkbox('newform', label=_('Create a new access request form'), id="newform") }}
			</div>
			<input type="radio" name="access" id="free" onclick="KATA.toggleAccess(this)" style="top: 0px" value="free" {% if data.access == 'free'%}checked{% endif %}>{{ _('directly downloadable') }}</input><br />
			<div id="urlDiv_free" {% if not data.accessrequestURL and not data.access == 'free' %}style="display:none"{% endif%}>
				{{ form.input('accessrequestURL', label=_('Web address for downloading the dataset'), id="accessURL", placeholder=_('http://mydata.com'), value=data.accessrequestURL, error=errors.accessrequestURL, classes=['control-medium'], control_classes=["kata-label-pluspad"], label_classes=['kata-input-comp']) }}
			</div> 
			<input type="radio" name="access" id="ident" onclick="KATA.toggleAccess(this)" style="top: 0px" value="ident" {% if data.access == 'ident'%}checked{% endif %}>{{ _('downloadable after registration / identification') }}</input><br />
			<div id="urlDiv_ident" {% if not data.accessrequestURL and not data.access == 'ident' %}style="display:none"{% endif%}>
			</div> 
			<input type="radio" name="access" id="contact" onclick="KATA.toggleAccess(this)" style="top: 0px" value="contact" {% if data.access == 'contact'%}checked{% endif %}>{{ _('only by contacting the distributor') }}</input><br />
		</div>
	</div>
	
	{% call form.input('licenseURL', id='licenseURL', label=_('License'), placeholder=_('eg. http://www.gnu.org/licenses/gpl.html or freeform'), value=data.licenseURL, error=errors.licenseURL, classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
		{{ kata_form.tooltip(tooltip=_('Usage and license fields are compulsory.<br /><br />Use the radio buttons and displayed fields to tell how to access your research data. Provide the download URL when such a field is displayed beside your chosen option. Note that this service supports the use of REMS service and you can automatically generate a basic access request form by checking the \"Create a new addess request form\" button when choosing the first option.<br /><br />Learn more about REMS from https://rems.csc.fi.<br /><br />Provide a license URL or a freeform license text to the License field.')) }} 
	{% endcall %}
</div>
</section>

{% snippet 'package/snippets/recommended_form.html', data=data, errors=errors, error_summary=error_summary, include_metadata=false, pkg_name=pkg_name %}