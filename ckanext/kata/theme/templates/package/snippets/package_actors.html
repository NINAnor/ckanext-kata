{% import 'macros/form.html' as form %}
{% import 'macros/kata_form.html' as kata_form %}

<section class="module">
  <h2 class="module-heading-add-dataset">{{ _('Agents and roles') }}</h2>
  <div class="module-content">
    {% set distributor = h.get_distributor(data) %}
    {% if distributor %}
      <input type="hidden" name="agent__999__role" value="distributor" />
      <input type="hidden" name="agent__999__name" value="{{ distributor.name }}" />
      <input type="hidden" name="agent__999__organisation" value="{{ distributor.organisation }}" />
    {% endif %}
    <h3 class="module-heading-add-dataset">{{ _('Distributor / publisher contact information') }}</h3>
    <div class="module-content">
      {#% set contact_name = data.maintainer if data.maintainer else user.fullname %#}
      {#% set contact_email = data.maintainer_email if data.maintainer_email else user.email %#}
      {% set contact = h.get_contact(data) %}
      {# If something added to __extras it may break current error rendering for authors and contacts. #}
      {% set distributor_errors = h.get_dict_errors(errors, '__extras', 'contact') %}

      {% call form.input('contact__0__name', label=_('Name'), id='contact__0__name', placeholder=_('John Doe'), value=contact.name, error=h.get_dict_field_errors(errors, 'contact', 0, 'name'), classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
        {{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type the name of the publisher. Publisher is someone or something that can be contacted if more information about the data is required or the person or organisation responsible for the data needs to be contacted.')) }}
      {% endcall %}

      {% call form.input('contact__0__phone', label=_('Phone'), id='contact__0__phone', placeholder=_('+35844122123'), value=contact.phone, error=h.get_dict_field_errors(errors, 'contact', 0, 'phone'), classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
        {{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type the contact phone number. The phone number must be in form \"+35812341234\".')) }}
      {% endcall %}

      {% call form.input('contact__0__email', label=_('Email'), id='contact__0__email', placeholder=_('john.doe@example.com'), value=contact.email, error=h.get_dict_field_errors(errors, 'contact', 0, 'email'), type='email', classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
        {{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type the contact e-mail address. The e-mail address is not shown publicly.')) }}
      {% endcall %}

      {% call form.input('contact__0__URL', label=_('Homepage'), id='contact__0__URL', placeholder=_('http://johndoe.com/contact'), value=contact.URL, error=h.get_dict_field_errors(errors, 'contact', 0, 'URL'), classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
        {{ kata_form.tooltip(tooltip=_('Field is compulsory.<br /><br />Type a valid web address to your web page. In case you don\'t have one, you could for example give an address to your research group\'s site or any site that could make it possible to contact the origin of the dataset in case of need.')) }}
      {% endcall %}

      {% if distributor_errors and distributor_errors is iterable %}
        <span class="error-block-kata">{{ distributor_errors|join('. ') }}</span>
      {% endif %}
    </div>
    <h3 class="module-heading-add-dataset">{{ _('Project that produced this dataset') }}</h3>
    <div class="module-content">
      <input type="checkbox" style="top: 0px;" name="projdis" onchange="$('#projdiv').toggle()" {% if h.get_funder(data) %}checked {% endif %}value="True" />{{ _('This dataset was produced in a project.') }}
    </div>
    <div class="module-content" id="projdiv" {% if not h.get_funder(data) %}style="display: none;"{% endif %}>
      {% set funders = h.get_funders(data) %}

      {% if funders|length == 0 %}
        {% do funders.append(dict(role='funder',)) %}
      {% endif %}

      <div data-module="custom-fields-kata" data-module-id="funders" data-module-numfields={{ funders|length }} data-module-index="agent-index" id="funders">
        {% set funder_errors = h.get_dict_errors(errors, '__extras', 'funder') %}

        {% for agent in funders %}
          <div class="control-group control-custom{{ " error" if funder_errors }}">
            {% set index = agent_index.increase() %}
            {% set agent_prefix = "agent__" ~ index ~ "__" %}
            <input type="hidden" id="{{ agent_prefix }}role" name="{{ agent_prefix }}role" value="funder" />

            {% call form.input(agent_prefix ~ 'name', label=_('Name'), id=agent_prefix ~ 'name', placeholder=_('my project'), value=agent.name, error=h.get_dict_field_errors(errors, 'agent', index, 'name'), classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
              {{ kata_form.tooltip(tooltip=_("Field is compulsory if checkbox \'This dataset was produced in a project.\' is checked.<br /><br />Type the project\'s name.")) }}
            {% endcall %}

              {% call form.input(agent_prefix ~ 'organisation', label=_('Funder'), id=agent_prefix ~ 'organisation', placeholder=_('my funder'), value=agent.organisation, error=h.get_dict_field_errors(errors, 'agent', index, 'organisation'), classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
                {{ kata_form.tooltip(tooltip=_("Field is compulsory if checkbox \'This dataset was produced in a project.\' is checked.<br /><br />Type the project funder\'s name.")) }}
              {% endcall %}

              {% call form.input(agent_prefix ~ 'fundingid', label=_('Funding id'), id=agent_prefix ~ 'fundingid', placeholder=_('1234'), value=agent['fundingid'], error=h.get_dict_field_errors(errors, 'agent', index, 'fundingid'), classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
                {{ kata_form.tooltip(tooltip=_("Field is compulsory if checkbox \'This dataset was produced in a project.\' is checked.<br /><br />Type the project\'s funding id. The funding id is not shown publicly.")) }}
              {% endcall %}

              {% call form.input(agent_prefix ~ 'URL', label=_('Homepage'), id=agent_prefix ~ 'URL', placeholder=_('http://myproject'), value=agent.URL, error=h.get_dict_field_errors(errors, 'agent', index, 'URL'), classes=['control-custom'], label_classes=['kata-input-comp'], attrs={'class': "kata-medium-input"}) %}
                {{ kata_form.tooltip(tooltip=_("Field is compulsory if checkbox \'This dataset was produced in a project.\' is checked.<br /><br />Type the project\'s homepage")) }}
                {% if loop.index0 == 0 %}
                  {{ kata_form.plusbutton(id="funders_add", onclick="$(\'#obtn__" ~ index ~ "__value_id\').change();") }}
                {% endif %}
              {% endcall %}

              <input style="display: none;" type="checkbox" id="obtn__{{ index }}__value_id" name="obtn__{{ index }}__value" class="btn btn-danger icon-plus-sign checkbox"/>
          </div>
        {% endfor %}
        {% if funder_errors and funder_errors is iterable %}<span class="error-block-kata">{{ funder_errors|join('. ') }}</span>{% endif %}
      </div>
    </div>
    <h3 class="module-heading-add-dataset">{{ _('Owner information')}}</h3>
    <div class="module-content">
      {% set owners = h.get_owners(data) %}

      {% if owners|length == 0 %}
        {% do owners.append(dict(role='owner',)) %}
      {% endif %}

      <div data-module="custom-fields-kata" data-module-id="owner" data-module-numfields={{ owners|length }} data-module-index="agent-index" id="owner">
        {% set owner_errors = h.get_dict_errors(errors, '__extras', 'owner') %}

        {% for agent in owners %}
          <div class="control-group control-custom{{ " error" if owner_errors }}">
            {% set index = agent_index.increase() %}
            {% set agent_prefix = "agent__" ~ index ~ "__" %}

            <label class="control-label kata-input-comp" for="agent__{{ index }}__name_id">{{ _('Owner identity') }}</label>
            <div class="controls editor">
              <input class="kata-medium-input" type="text" placeholder="{{ _('identification URL or name') }}" id="agent__{{ index }}__name_id" name="agent__{{ index }}__name" value="{{ agent.name }}" />
              {% if loop.index0 == 0 %}
                {{ kata_form.tooltip(tooltip=_("Field is compulsory.<br /><br />Type the dataset owner\'s name or an identifier, for example an ORCID identifier.")) }}
                {{ kata_form.plusbutton(id="owners_add", onclick="$(\'#obtn__" ~ index ~ "__value_id\').change();") }}
              {% endif %}

              <input type="hidden" id="{{ agent_prefix }}role" name="{{ agent_prefix }}role" value="owner" />

            </div>
            <input style="display: none;" type="checkbox" id="obtn__{{ index }}__value_id" name="obtn__{{ index }}__value" class="btn btn-danger icon-plus-sign checkbox"/>

          </div>
        {% endfor %}
        {% if owner_errors and owner_errors is iterable %}<span class="error-block-kata">{{ owner_errors|join('. ') }}</span>{% endif %}
      </div>
    </div>
  </div>
</section>
