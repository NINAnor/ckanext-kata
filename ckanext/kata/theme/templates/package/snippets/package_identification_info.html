{% import 'macros/form.html' as form %}
{% import 'macros/kata_form.html' as kata_form %}

{% set pids = h.get_pids_by_type('data', data, primary=True) %}
{% if not pids %}
  {% do pids.append(dict(type='data', primary='True')) %}
{% endif %}
{% for pid_type in h.get_pid_types() %}
  {% do pids.extend( h.get_pids_by_type(pid_type, data, primary=False)) %}
{% endfor %}
{% if pids | length == 1 %}
  {% do pids.append(dict(type='data')) %}
{% endif %}

{% set index = h.create_loop_index() %}
{% set pid_types = h.get_pid_types() %}

{% set primary_pids = h.get_pids_by_type('data', data, primary=True) %}
{% set primary_pid = primary_pids[0] or dict(type='data', primary='True') %}

<div class="tab-content-inner">

  {# NOTE: Parameter "error" passed to kata_form.input macro needs to be corrected in all cases since it is same as in package_actors.html #}

  {% set primary_pid_readonly = " readonly" if (primary_pid.id or data.id) and not errors.get('pids', [])[index.index]%}
  {% call kata_form.input(
    'pids__' ~ index ~ '__id', label=_('Primary data identifier')+' * ',
     id='pids__' ~ index ~ '__id', placeholder='http://www.pid.com/1234',
     value=primary_pid.id,
     label_classes=['kata-input-comp'], control_classes=['kata-medium'],
     attrs={'class': "kata-medium-input pid kata-pid-input-wide pids_" ~ index, primary_pid_readonly:''})%}

    <div class="form-double-instructions-container">
      {{ kata_form.tooltip(tooltip=_('Field is compulsory but an automatically generated primary data identifier is provided if left empty.<br /><br />PID is a permanent identifier, preferably an HTTP URI. Note that if your data is accessible via access application like REMS, the primary identifier is sent to the service as the data identifier.<br /><br />The automatically generated PID is a URN identifier from the national library of Finland, of form \"urn:nbn:fi:csc-kata[unique number]\". Visit <a href="http://www.nationallibrary.fi" target="_blank">http://www.nationallibrary.fi</a> for more information.')) }}
      {{ kata_form.warning_tooltip(tooltip=_('Note that the primary data identifier can NOT be edited after saving the dataset.')) }}
    </div>

    <input type="hidden" id="pids__{{ index }}__primary" name="pids__{{ index }}__primary" value="True" />
    <input type="hidden" name="pids__{{ index }}__type" value="data" />

    {% if errors.pids and errors.pids[index.index] %}
      <span class="error-block kata-pid-field-error separate-error error-block-margin">{{ errors.pids[index.index].get('id')|join('. ') }}</span>
    {% endif %}
  {% endcall %}

  {% do index.increase() %}
  <input type="hidden" id="name" name="name" value="" />

  {% for pid_type in pid_types %}

    {% if pid_type == 'data' %}
      {% set additional_data_identifier_label = _('Additional data identifiers') %}
    {% else %}
      {% set additional_data_identifier_label = _(pid_type | capitalize) + _(' identifiers') %}
    {% endif %}
    <label class="form-label kata-input-comp" for="pids__{{ index }}__id" style="float: left;font-weight: 700;width: 30%;text-align: right;">{{ additional_data_identifier_label or _('Custom') }}</label>

    <div data-module="custom-fields-kata" data-module-id="pids-{{ pid_type }}" id="pids-{{ pid_type }}" data-module-index="pid-index" data-module-keep="type" data-module-hide=".hideclone" data-module-remove=".error-block" class="custom-fields-container">
      {% set pids = h.get_pids_by_type(pid_type, data, primary=False) or [dict(type=pid_type, primary=(pid_type == 'primary_data'))] %}
      {% for pid in pids %}
        {% set pid_readonly = " readonly" if pid.id and not (h.asbool(pid.get('primary')) and errors and not data.id) %}
        <div class="control-custom">
          <div class="form-row">
            <div class="form-content kata-medium{{ ' error' if errors }}{{ ' no-label-controls' if not hasLabel}}">
              <input id="pids__{{ index }}__id" type="text" name="pids__{{ index }}__id" value="{{ pid.id | empty_and_escape }}" placeholder="http://www.pid.com/1234" class="kata-medium-input pid kata-pid-input-wide pids_{{ index }}" {{ pid_readonly }} />
              {# {% if errors and errors is iterable %}<span class="error-block">{{ errors|join(', ') }}</span>{% endif %}#}
            </div>
             {% if pid.id and not h.asbool(pid.get('primary')) %}
                <input style="margin: 3px; width: 20px; top: 6px" type="checkbox" id="pids__{{ index }}__modify" title="{{ _('Check this to correct errors in an existing PID') }}" onchange="$('input.pids_{{ index }}').prop('readonly',!$('input.pids_{{ index }}').prop('readonly'));" />
                <label class="control-label katalabel-pid2 hideclone" onclick="$('#pids__{{ index }}__modify').prop('checked', !$('#pids__{{ index }}__modify').prop('checked')); $('input.pids_{{ index }}').prop('readonly',!$('input.pids_{{ index }}').prop('readonly'));">{{ _('Edit') if pids[0].id }}</label>
              {% endif %}

              {% if loop.first %}
                {{ kata_form.tooltip(tooltip=_('PID is a permanent identifier, preferably an HTTP URI.')) }}
                <input style="display: none;" type="checkbox" id="pids__{{index}}__value" name="pids__{{index}}__value" class="btn btn-danger kata-plus-btn icon-plus-sign checkbox"/>
                {{ kata_form.plusbutton(id='pids_add-{{ pid_type }}', text=_('Add'), onclick="$(\'#pid_btn__" ~ index ~ "__value_id\').change();") }}
                <input style="display: none;" type="checkbox" id="pid_btn__{{ index }}__value_id" name="pid_btn__{{ index }}__value" class="btn btn-danger kata-plus-btn icon-plus-sign checkbox"/>
              {% endif %}

              <input type="hidden" name="pids__{{ index }}__type" value="{{ pid_type }}" />
              {% if errors.pids and errors.pids[index.index] %}
                <span class="error-block kata-pid-field-error separate-error error-block-margin">{{ errors.pids[index.index].get('id')|join('. ') }}</span>
              {% endif %}
          </div>

          {# NOT USED BECAUSE LABEL OF THE FIRST PID CANNOT BE SET AS IT IS BEING SET IN KATA_FORM.INPUT - OTHERWISE LABEL GETS COPIED TO CUSTOM FIELDS
          {% call kata_form.input(
            'pids__' ~ index ~ '__id', label=additional_data_identifier_label,
             id='pids__' ~ index ~ '__id', placeholder='http://www.pid.com/1234',
             value=pid.id,
             label_classes=['kata-input-comp'], control_classes=['kata-medium'],
             attrs={'class': "kata-medium-input pid kata-pid-input-wide pids_" ~ index, pid_readonly:''}, hasLabel=loop.first)%}

            {% if pid.id and not h.asbool(pid.get('primary')) %}
              <input style="margin: 3px; width: 20px; top: 6px" type="checkbox" id="pids__{{ index }}__modify" title="{{ _('Check this to correct errors in an existing PID') }}" onchange="$('input.pids_{{ index }}').prop('readonly',!$('input.pids_{{ index }}').prop('readonly'));" />
              <label class="control-label katalabel-pid2 hideclone" onclick="$('#pids__{{ index }}__modify').prop('checked', !$('#pids__{{ index }}__modify').prop('checked')); $('input.pids_{{ index }}').prop('readonly',!$('input.pids_{{ index }}').prop('readonly'));">{{ _('Edit') if pids[0].id }}</label>
            {% endif %}

            {% if loop.first %}
              {{ kata_form.tooltip(tooltip=_('PID is a permanent identifier, preferably an HTTP URI.')) }}
              <input style="display: none;" type="checkbox" id="pids__{{index}}__value" name="pids__{{index}}__value" class="btn btn-danger kata-plus-btn icon-plus-sign checkbox"/>
              {{ kata_form.plusbutton(id='pids_add-{{ pid_type }}', text=_('Add'), onclick="$(\'#pid_btn__" ~ index ~ "__value_id\').change();") }}
              <input style="display: none;" type="checkbox" id="pid_btn__{{ index }}__value_id" name="pid_btn__{{ index }}__value" class="btn btn-danger kata-plus-btn icon-plus-sign checkbox"/>
            {% endif %}

            <input type="hidden" name="pids__{{ index }}__type" value="{{ pid_type }}" />
            {% if errors.pids and errors.pids[index.index] %}
              <span class="error-block kata-pid-field-error">{{ errors.pids[index.index].get('id')|join('. ') }}</span>
            {% endif %}
          {% endcall %}
          #}


        </div>
      {% do index.increase() %}
      {% endfor %}
    </div>
  {% endfor %}

  {% set pid_errors = h.get_dict_errors(errors, '__extras', 'pids') %}
  {% if pid_errors and pid_errors is iterable %}
    <span class="separate-error error-block error-block-margin">{{ pid_errors|join('. ') }}</span>
  {% endif %}

  <input type="hidden" value="{{ index }}" id="pid-index" />

  <div class="form-row">
    <label for="generate_version_pid" class="control-label kata-input-comp kata-wide-label">{{ _('Generate new version identifier') }}</label>
    <input id="generate_version_pid" type="checkbox" name="generate_version_pid" class="checkbox checkbox-generate" {{ 'checked' if not pids[0].id }} title='{{ _("Check to automatically generate a permanent identifier.") }}'/>
    {{ kata_form.tooltip(tooltip=_('Generate a new permanent identifier (PID) for a version of the data.<br /><br />PID is a permanent, unique, identifier, preferably a URI. This specific PID is for the current data version. You can add your own identifier or use one generated by the service by checking this checkbox.<br /><br />The automatically generated PID is a URN identifier from the national library of Finland, of form \"urn:nbn:fi:csc-kata[unique number]\". Visit <a href=\"http://www.nationallibrary.fi\" target=\"_blank\">http://www.nationallibrary.fi</a> for more information.')) }}
  </div>

  {% set lang = h.lang() %}

  <div class="form-row">
  {% call kata_form.input_block2("last_modified", _('Modification date'), error=errors.version, control_classes=['controls-row', 'controls-wide', 'modification-date-controls'], label_classes=['kata-input-comp', 'kata-wide-label'], extra_html=kata_form.tooltip(tooltip=_('Field is compulsory but an automatically generated date is provided.<br><br>The modification date tells when the data has last been modified. Click the calendar icon to open a calendar tool to choose the modification date for this dataset. Time can be entered if "use exact time" is chosen.<br><br>Note that this tool requires JavaScript to be enabled in the browser.'))) %}
    <div data-module="kata-datetimepicker"
         data-module-currentlang="{{ lang }}" data-module-name="version"
         data-module-value="{{data.version}}" data-module-defaultnow="true"
         data-module-disabled="true">

      <div class="kata-datetimepicker-parent"></div>

      <div class="kata-datepicker-error"></div>
    </div>
  {% endcall %}
  </div>
</div>
