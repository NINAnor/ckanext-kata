{% import 'macros/form.html' as form %}
{% import 'macros/kata_form.html' as kata_form %}

{% set pids = h.get_pids_by_type('data', data, primary=True) %}
{% if not pids %}
  {% do pids.append(dict(type='data', primary='True')) %}
{% endif %}

{% for pid_type in h.get_pid_types() %}
  {% do pids.extend( h.get_pids_by_type(pid_type, data, primary=False)) %}
{% endfor %}

{% if pids | length == 1 %}
  {% do pids.append(dict(type='data')) %}
{% endif %}

<section class="module">
  <h2 class="module-heading-add-dataset">{{ _('Identification information of data') }}</h2>
  <div class="module-content">
    <div data-module="custom-fields-kata" data-module-id="pids" id="pids">
      <label class="control-label katalabel-pid1"><span>{{ _('PID type') }}</span></label>
      <label class="control-label katalabel-pid-wide"><span>{{ _('Identifier') }}</span></label>
      {# <label class="control-label katalabel-pid1"><span>{{ _('Provider') }}</span></label> #}
      <label class="control-label katalabel-pid2"><span>{{ _('Edit') if pids[0].id }}&nbsp;</span></label>

      <input type="hidden" id="name" name="name" value="" />
      {% for pid in pids %}
        {% set index = loop.index0 %}

        <div class="control-group control-custom">
          <ul class="kata">
            <li class="kata">
              <div class="input-prepend">
                {% if h.asbool(pid.get('primary')) %}
                  <input type="hidden" id="pids__{{ index }}__primary" name="pids__{{ index }}__primary" value="True" />
                  <input style="width: 90px;" id="pids_dummy" name="pids_dummy" type="text" disabled value="{{ _('Data, primary') }}">
                  <input type="hidden" id="pids__{{ index }}__type" name="pids__{{ index }}__type" value="data" />
                {% else %}
                  <select name="pids__{{ index }}__type" class="pid pids_{{ index }}" {# 'readonly' if pid.id #} style="width: 104px;">
                    {% for pid_type in h.get_pid_types() %}
                      <option value="{{ pid_type }}" {{ 'selected' if pid.type == pid_type else '' }}>{{ _(pid_type | capitalize) }}</option>
                    {% endfor %}
                  </select>
                {% endif %}
              </div>
            </li>
            <li class="kata">
              <div class="input-prepend">
                <input class="pid kata-pid-input-wide pids_{{ index }}" {{ 'readonly' if pid.id and not (h.asbool(pid.get('primary')) and errors and not data.id) }} type="text" id="pids__{{ index }}__id" name="pids__{{ index }}__id" value="{{ pid.id }}" />
              </div>
            </li>
            <li class="kata">
              <div class="input-prepend">
                {# <input class="pid kata-pid-input pids_{{ index }}" {{ 'readonly' if pid.id }} type="text" id="pids__{{ index }}__provider" name="pids__{{ index }}__provider" value="{{ pid.provider }}" /> #}
                {% if pid.id and not h.asbool(pid.get('primary')) %}
                  &nbsp;<input style="width: 30px; top: 0px" type="checkbox" id="pids__{{ index }}__modify" title="{{ _('Check this to correct errors in an existing PID') }}"
                  onchange="$('input.pids_{{ index }}').prop('readonly',!$('input.pids_{{ index }}').prop('readonly'));" />
                {% endif %}
              </div>
            </li>
            {% if index == (pids | length) - 1 %}
              <li class="kata">
                {{ kata_form.tooltip(tooltip=_('PIDs are compulsory. An automatically generated primary data PID is provided if left empty.<br /><br />PID is a permanent identifier, preferably an HTTP URI. Note that the first PID is used as primary data PID. <br /><br />The automatically generated PID is a URN identifier provided by the national library of Finland, of form \"urn:nbn:fi:csc-kata[unique number]\". Visit http://www.nationallibrary.fi/ for more information.')) }}
                <input style="display: none;" type="checkbox" id="pids__{{index}}__value" name="pids__{{index}}__value" class="btn btn-danger kata-plus-btn icon-plus-sign checkbox"/>
              </li>
              <li class="kata">
                {{ kata_form.plusbutton(id='pids_add', onclick="$(\'#pid_btn__" ~ index ~ "__value_id\').change();") }}
                <input style="display: none;" type="checkbox" id="pid_btn__{{ index }}__value_id" name="pid_btn__{{ index }}__value" class="btn btn-danger kata-plus-btn icon-plus-sign checkbox"/>
              </li>
            {% endif %}
          </ul>
        </div>
      {% endfor %}

      {% set pid_errors = h.get_dict_errors(errors, '__extras', 'pids') %}
      {% if pid_errors and pid_errors is iterable %}<span class="error-block">{{ pid_errors|join('. ') }}</span>{% endif %}

    </div>
    <div class="control-group control-custom">
      <label class="control-label kata-input-comp" for="new_version_pid">{{ _('Generate new version identifier') }}</label>
      <input type='checkbox' id='generate_version_pid' name='generate_version_pid' class='checkbox checkbox-generate' {{ 'checked' if not pids[0].id }} title='{{ _("Check to automatically generate a permanent identifier.") }}'/>
      {{ kata_form.tooltip(tooltip=_('Generate a new permanent identifier (PID) for a version of the data.<br /><br />PID is a permanent, unique, identifier, preferably a URI. This specific PID is for the current data version. You can add your own identifier or use one generated by the service by leaving the text field empty and checking the checkbox next to the field. <br /><br />The automatically generated PID is a URN identifier from the national library of Finland, of form \"urn:nbn:fi:csc-kata[unique number]\". Visit http://www.nationallibrary.fi for more information.')) }}
      {# kata_form.warning_tooltip(tooltip=_('Note that the version identifier can NOT be edited after saving the dataset, but you can add new version identifiers.')) #}
    </div>
    {% call form.input_block("last_modified", _('Modification date'), error=errors.version, control_classes=["kata-label-pluspad"], label_classes=['kata-input-comp']) %}
      <div class="control-group control-custom">
        <div data-module="dateselect-simple-kata">
          <input type="text" readonly id="last_modified" name="version" value="{{data.version}}" />
          {{ kata_form.tooltip(tooltip=_('Field is compulsory but an automatically generated date is provided.<br /><br />The modification date tells when the data has last been modified. Click the field to open a calendar tool to choose the modification date and time for this dataset. Accept and insert the date to the field by pressing the Done button. By default, the time zone is Z (Zulu Time Zone), which corresponds to the UTC time zone.<br /><br />Note that this tool requires JavaScript to be enabled in the browser.')) }}
        </div>
      </div>
    {% endcall %}
  </div>

</section>
