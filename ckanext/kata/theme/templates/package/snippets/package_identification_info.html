{% import 'macros/form.html' as form %}
{% import 'macros/kata_form.html' as kata_form %}

{% set pids = h.get_pids_by_type('data', data, primary=True, use_id_or_name=True) %}
{% for pid_type in h.get_pid_types() %}
  {% do pids.extend( h.get_pids_by_type(pid_type, data, primary=False)) %}
{% endfor %}

{% if not pids %}
  {% do pids.append(dict(type='data', primary='True')) %}
{% endif %}

<section class="module">
  <h2 class="module-heading-add-dataset">{{ _('Identification information of data') }}</h2>
  <div class="module-content">
    <div data-module="custom-fields-kata" data-module-id="pids" id="pids">
      <label class="control-label katalabel-pid1"><span>{{ _('PID type') }}</span></label>
      <label class="control-label katalabel-pid-wide"><span>{{ _('Identifier') }}</span></label>
      <label class="control-label katalabel-pid2"><span>{{ _('Provider') }}</span></label>
      <label class="control-label katalabel-pid2"><span>&nbsp;</span></label>

      <input type="hidden" id="name" name="name" value="" />
      {% for pid in pids %}
        {% set index = loop.index0 %}

        {% if h.asbool(pid.get('primary')) %}
          <input type="hidden" id="pids__{{ index }}__primary" name="pids__{{ index }}__primary" value="True" />
        {% endif %}

        <div class="control-group control-custom">
          <ul class="kata">
            <li class="kata">
              <div class="input-prepend">
                {% if index == 0 %}
                    <input style="width: 82px;" id="pids_dummy" name="pids_dummy" type="text" disabled value="{{ _('Primary Data') }}">
                    <input type="hidden" id="pids__{{ index }}__type" name="pids__{{ index }}__type" value="data" />
                {% else %}
                  <select name="pids__{{ index }}__type" style="width: 96px;">
                    {% for pid_type in h.get_pid_types() %}
                      <option value="{{ pid_type }}" {{ 'selected' if pid.type == pid_type else '' }}>{{ _(pid_type | capitalize) }}</option>
                    {% endfor %}
                  </select>
                {% endif %}
              </div>
            </li>
            <li class="kata">
              <div class="input-prepend">
                <input class="kata-pid-input-wide" type="text" id="pids__{{ index }}__id" name="pids__{{ index }}__id" value="{{ pid.id }}" />
              </div>
            </li>
            <li class="kata">
              <div class="input-prepend">
                <input class="kata-pid-input" type="text" id="pids__{{ index }}__provider" name="pids__{{ index }}__provider" value="{{ pid.provider }}" />
              </div>
            </li>
            {% if index == 0 %}
              <li class="kata">
                {{ kata_form.tooltip(tooltip=_('Field is compulsory but automatically generated if left empty.<br /><br />PID is a permanent, unique, identifier, preferably a URI. You can add your own identifier or use one generated by the service. Note that the first PID is the primary data PID. <br /><br />The automatically generated PID is a URN identifier from the national library of Finland, of form \"urn:nbn:fi:csc-kata[unique number]\". Visit http://www.nationallibrary.fi/ for more information.')) }}
                <input style="display: none;" type="checkbox" id="pids__{{index}}__value" name="pids__{{index}}__value" class="btn btn-danger kata-plus-btn icon-plus-sign checkbox"/>
              </li>
              <li class="kata">
                {{ kata_form.plusbutton(onclick="$(\'#pid_btn__" ~ index ~ "__value_id\').change();") }}
                <input style="display: none;" type="checkbox" id="pid_btn__{{index}}__value_id" name="pid_btn__{{index}}__value" class="btn btn-danger kata-plus-btn icon-plus-sign checkbox"/>
              </li>
            {% endif %}
          </ul>
        </div>
      {% endfor %}

      {% set pid_errors = h.get_dict_errors(errors, '__extras', 'pids') %}
      {% if pid_errors and pid_errors is iterable %}<span class="error-block">{{ pid_errors|join('. ') }}</span>{% endif %}

      <div class="control-group control-custom">
        <label class="control-label kata-input-comp" for="new_version_pid">{{ _('Generate data version identifier') }}</label>
        <input type='checkbox' id='generate_version_pid' name='generate_version_pid' class='checkbox checkbox-generate' checked='checked' title='{{ _("Check to automatically generate a permanent identifier.") }}'/>
        {{ kata_form.tooltip(tooltip=_('Field is compulsory but automatically generated if left empty with the checkbox checked.<br /><br />PID is a permanent, unique, identifier, preferably a URI. This specific PID is for the current data version. You can add your own identifier or use one generated by the service by leaving the text field empty and checking the checkbox next to the field. <br /><br />The automatically generated PID is a URN identifier from the national library of Finland, of form \"urn:nbn:fi:csc-kata[unique number]\". Visit http://www.nationallibrary.fi for more information.')) }}
        {{ kata_form.warning_tooltip(tooltip=_('Note that the version identifier can NOT be edited after saving the dataset, but you can add new version identifiers.')) }}
      </div>
    </div>

    {% call form.input_block("last_modified", _('Modification date'), error=errors.version, control_classes=["kata-label-pluspad"], label_classes=['kata-input-comp']) %}
      <div class="control-group control-custom">
        <div data-module="dateselect-simple-kata">
          <input type="text" readonly id="last_modified" name="version" value="{{data.version}}" />
          {{ kata_form.tooltip(tooltip=_('Field is compulsory but an automatically generated date is provided.<br /><br />The modification date tells when the data has last been modified. Click the field to open a calendar tool to choose the modification date and time for this dataset. Accept and insert the date to the field by pressing the Done button. By default, the time zone is Z (Zulu Time Zone), which corresponds to the UTC time zone.<br /><br />Note that this tool requires JavaScript to be enabled in the browser.')) }}
        </div>
      </div>
    {% endcall %}
  </div>

</section>
