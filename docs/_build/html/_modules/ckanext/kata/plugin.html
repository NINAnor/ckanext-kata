<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ckanext.kata.plugin &mdash; Kata metadata catalogue documentation</title>
    
    <link rel="stylesheet" href="../../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Kata metadata catalogue documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="../../../index.html">Kata</a></div>
        <div class="rel">
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ckanext.kata.plugin</h1><div class="highlight"><pre>
<span class="c"># pylint: disable=unused-argument</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Main plugin file for Kata CKAN extension. Compatible with CKAN 2.1 and 2.2.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">ckan.lib.base</span> <span class="kn">import</span> <span class="n">g</span><span class="p">,</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">ckan.common</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">ckan.lib.plugins</span> <span class="kn">import</span> <span class="n">DefaultDatasetForm</span>
<span class="kn">from</span> <span class="nn">ckan.plugins</span> <span class="kn">import</span> <span class="p">(</span><span class="n">implements</span><span class="p">,</span>
                          <span class="n">toolkit</span><span class="p">,</span>
                          <span class="n">IActions</span><span class="p">,</span>
                          <span class="n">IAuthFunctions</span><span class="p">,</span>
                          <span class="n">IConfigurable</span><span class="p">,</span>
                          <span class="n">IConfigurer</span><span class="p">,</span>
                          <span class="n">IDatasetForm</span><span class="p">,</span>
                          <span class="n">IPackageController</span><span class="p">,</span>
                          <span class="n">IRoutes</span><span class="p">,</span>
                          <span class="n">IFacets</span><span class="p">,</span>
                          <span class="n">ITemplateHelpers</span><span class="p">,</span>
                          <span class="n">SingletonPlugin</span><span class="p">)</span>
                              
<span class="kn">from</span> <span class="nn">ckan.plugins.core</span> <span class="kn">import</span> <span class="n">unload</span>

<span class="kn">from</span> <span class="nn">ckanext.kata.schemas</span> <span class="kn">import</span> <span class="n">Schemas</span>

<span class="kn">from</span> <span class="nn">ckanext.kata</span> <span class="kn">import</span> <span class="n">actions</span><span class="p">,</span> <span class="n">auth_functions</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">helpers</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;ckanext.kata&#39;</span><span class="p">)</span>     <span class="c"># pylint: disable=invalid-name</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">toolkit</span>                                 <span class="c"># pylint: disable=invalid-name</span>

<span class="c">###### Monkey patch for repoze.who ######</span>
<span class="c"># Enables secure setting for cookies</span>
<span class="c"># Part of repoze.who since version 2.0a4</span>

<span class="kn">from</span> <span class="nn">repoze.who.plugins.auth_tkt</span> <span class="kn">import</span> <span class="n">AuthTktCookiePlugin</span>

<span class="k">def</span> <span class="nf">_now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_get_monkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">max_age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">max_age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_age</span><span class="p">)</span>
        <span class="n">later</span> <span class="o">=</span> <span class="n">_now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">max_age</span><span class="p">)</span>
        <span class="c"># Wdy, DD-Mon-YY HH:MM:SS GMT</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">later</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="c"># the Expires header is *required* at least for IE7 (IE7 does</span>
        <span class="c"># not respect Max-Age)</span>
        <span class="n">max_age</span> <span class="o">=</span> <span class="s">&quot;; Max-Age=</span><span class="si">%s</span><span class="s">; Expires=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">max_age</span><span class="p">,</span> <span class="n">expires</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_age</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="n">secure</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">secure</span><span class="p">:</span>
        <span class="n">secure</span> <span class="o">=</span> <span class="s">&#39;; secure; HttpOnly&#39;</span>

    <span class="n">cur_domain</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_HOST&#39;</span><span class="p">,</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SERVER_NAME&#39;</span><span class="p">))</span>
    <span class="n">wild_domain</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">cur_domain</span>
    <span class="n">cookies</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;; Path=/</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookie_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">max_age</span><span class="p">,</span> <span class="n">secure</span><span class="p">)),</span>
        <span class="p">(</span><span class="s">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;; Path=/; Domain=</span><span class="si">%s%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookie_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cur_domain</span><span class="p">,</span> <span class="n">max_age</span><span class="p">,</span> <span class="n">secure</span><span class="p">)),</span>
        <span class="p">(</span><span class="s">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;; Path=/; Domain=</span><span class="si">%s%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookie_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">wild_domain</span><span class="p">,</span> <span class="n">max_age</span><span class="p">,</span> <span class="n">secure</span><span class="p">))</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="n">cookies</span>

<span class="n">AuthTktCookiePlugin</span><span class="o">.</span><span class="n">_get_cookies</span> <span class="o">=</span> <span class="n">_get_monkeys</span>

<span class="c">###### End of Monkey patch ######</span>

<div class="viewcode-block" id="KataPlugin"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin">[docs]</a><span class="k">class</span> <span class="nc">KataPlugin</span><span class="p">(</span><span class="n">SingletonPlugin</span><span class="p">,</span> <span class="n">DefaultDatasetForm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kata functionality and UI plugin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># pylint: disable=no-init, no-self-use</span>

    <span class="n">implements</span><span class="p">(</span><span class="n">IDatasetForm</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">implements</span><span class="p">(</span><span class="n">IConfigurer</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">implements</span><span class="p">(</span><span class="n">IConfigurable</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">implements</span><span class="p">(</span><span class="n">IPackageController</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">implements</span><span class="p">(</span><span class="n">ITemplateHelpers</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">implements</span><span class="p">(</span><span class="n">IActions</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">implements</span><span class="p">(</span><span class="n">IAuthFunctions</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">implements</span><span class="p">(</span><span class="n">IFacets</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">implements</span><span class="p">(</span><span class="n">IRoutes</span><span class="p">,</span> <span class="n">inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="n">create_package_schema</span> <span class="o">=</span> <span class="n">Schemas</span><span class="o">.</span><span class="n">create_package_schema</span>
    <span class="n">create_package_schema_oai_dc</span> <span class="o">=</span> <span class="n">Schemas</span><span class="o">.</span><span class="n">create_package_schema_oai_dc</span>
    <span class="n">create_package_schema_ddi</span> <span class="o">=</span> <span class="n">Schemas</span><span class="o">.</span><span class="n">create_package_schema_ddi</span>
    <span class="n">update_package_schema</span> <span class="o">=</span> <span class="n">Schemas</span><span class="o">.</span><span class="n">update_package_schema</span>
    <span class="n">update_package_schema_oai_dc</span> <span class="o">=</span> <span class="n">Schemas</span><span class="o">.</span><span class="n">update_package_schema_oai_dc</span>
    <span class="n">show_package_schema</span> <span class="o">=</span> <span class="n">Schemas</span><span class="o">.</span><span class="n">show_package_schema</span>
    <span class="n">tags_schema</span> <span class="o">=</span> <span class="n">Schemas</span><span class="o">.</span><span class="n">tags_schema</span>

<div class="viewcode-block" id="KataPlugin.before_map"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.before_map">[docs]</a>    <span class="k">def</span> <span class="nf">before_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override IRoutes.before_map()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">get</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="s">&quot;ckanext.kata.controllers:MetadataController&quot;</span>
        <span class="n">api_controller</span> <span class="o">=</span> <span class="s">&quot;ckanext.kata.controllers:KATAApiController&quot;</span>
        <span class="c"># Full stops from harvested objects screw up the read method</span>
        <span class="c"># when using the default ckan route</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/dataset/{id:.*?}.{format:rdf}&#39;</span><span class="p">,</span>
                  <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckan.controllers.package:PackageController&quot;</span><span class="p">,</span> 
                  <span class="n">action</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/urnexport&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&#39;urnexport&#39;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/api/2/util/organization_autocomplete&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="n">api_controller</span><span class="p">,</span>
                    <span class="n">conditions</span><span class="o">=</span><span class="n">get</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;organization_autocomplete&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/api/2/util/discipline_autocomplete&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="n">api_controller</span><span class="p">,</span>
                    <span class="n">conditions</span><span class="o">=</span><span class="n">get</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;discipline_autocomplete&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/api/2/util/location_autocomplete&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="n">api_controller</span><span class="p">,</span>
                    <span class="n">conditions</span><span class="o">=</span><span class="n">get</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;location_autocomplete&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/api/2/util/tag/autocomplete&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="n">api_controller</span><span class="p">,</span>
                    <span class="n">conditions</span><span class="o">=</span><span class="n">get</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;tag_autocomplete&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/api/2/util/media_type_autocomplete&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="n">api_controller</span><span class="p">,</span>
                    <span class="n">conditions</span><span class="o">=</span><span class="n">get</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;media_type_autocomplete&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/unlock_access/{id}&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:AccessRequestController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;unlock_access&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/create_request/{pkg_id}&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:AccessRequestController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;create_request&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/render_edit_request/{pkg_id}&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:AccessRequestController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;render_edit_request&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/request_dataset/send/{pkg_id}&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:ContactController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;send_request&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/request_dataset/{pkg_id}&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:ContactController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;render_request&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/contact/send/{pkg_id}&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:ContactController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;send_contact&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/contact/{pkg_id}&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:ContactController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;render_contact&quot;</span><span class="p">)</span>
        <span class="c"># map.connect(&#39;/dataset/import_xml/&#39;,</span>
        <span class="c">#             controller=&quot;ckanext.harvest.controllers.view:ViewController&quot;,</span>
        <span class="c">#             action=&quot;import_xml&quot;)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/user/logged_in&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:KataUserController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;logged_in&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/dataset/&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:KataPackageController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;advanced_search&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;help&#39;</span><span class="p">,</span>
                    <span class="s">&#39;/help&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:KataInfoController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;render_help&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;faq&#39;</span><span class="p">,</span>
                    <span class="s">&#39;/faq&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:KataInfoController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;render_faq&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/package_administration/{name}&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:KataPackageController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;dataset_editor_manage&quot;</span><span class="p">)</span>
        <span class="nb">map</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;/dataset_editor_delete/{name}&#39;</span><span class="p">,</span>
                    <span class="n">controller</span><span class="o">=</span><span class="s">&quot;ckanext.kata.controllers:KataPackageController&quot;</span><span class="p">,</span>
                    <span class="n">action</span><span class="o">=</span><span class="s">&quot;dataset_editor_delete&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">map</span>
</div>
<div class="viewcode-block" id="KataPlugin.get_auth_functions"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.get_auth_functions">[docs]</a>    <span class="k">def</span> <span class="nf">get_auth_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dict of all the authorization functions which the</span>
<span class="sd">        implementation overrides</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;package_update&#39;</span><span class="p">:</span> <span class="n">auth_functions</span><span class="o">.</span><span class="n">is_owner</span><span class="p">,</span>
                <span class="s">&#39;resource_update&#39;</span><span class="p">:</span> <span class="n">auth_functions</span><span class="o">.</span><span class="n">edit_resource</span><span class="p">,</span>
                <span class="s">&#39;package_delete&#39;</span><span class="p">:</span> <span class="n">auth_functions</span><span class="o">.</span><span class="n">package_delete</span><span class="p">,</span>
                <span class="p">}</span>
</div>
<div class="viewcode-block" id="KataPlugin.get_actions"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.get_actions">[docs]</a>    <span class="k">def</span> <span class="nf">get_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Register actions. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;package_show&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">package_show</span><span class="p">,</span>
                <span class="s">&#39;package_create&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">package_create</span><span class="p">,</span>
                <span class="s">&#39;package_update&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">package_update</span><span class="p">,</span>
                <span class="s">&#39;package_delete&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">package_delete</span><span class="p">,</span>
                <span class="s">&#39;package_search&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">package_search</span><span class="p">,</span>
                <span class="s">&#39;resource_create&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">resource_create</span><span class="p">,</span>
                <span class="s">&#39;resource_update&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">resource_update</span><span class="p">,</span>
                <span class="s">&#39;resource_delete&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">resource_delete</span><span class="p">,</span>
                <span class="s">&#39;group_list&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">group_list</span><span class="p">,</span>
                <span class="s">&#39;group_create&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">group_create</span><span class="p">,</span>
                <span class="s">&#39;group_update&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">group_update</span><span class="p">,</span>
                <span class="s">&#39;group_delete&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">group_delete</span><span class="p">,</span>
                <span class="s">&#39;related_create&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">related_create</span><span class="p">,</span>
                <span class="s">&#39;related_update&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">related_update</span><span class="p">,</span>
                <span class="s">&#39;related_delete&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">related_delete</span><span class="p">,</span>
                <span class="s">&#39;member_create&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">member_create</span><span class="p">,</span>
                <span class="s">&#39;member_delete&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">member_delete</span><span class="p">,</span>
                <span class="s">&#39;organization_create&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">organization_create</span><span class="p">,</span>
                <span class="s">&#39;organization_update&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">organization_update</span><span class="p">,</span>
                <span class="s">&#39;organization_delete&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">organization_delete</span><span class="p">,</span>
                <span class="s">&#39;dataset_editor_delete&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">dataset_editor_delete</span><span class="p">,</span>
                <span class="s">&#39;dataset_editor_add&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="o">.</span><span class="n">dataset_editor_add</span><span class="p">,</span>
                <span class="p">}</span>
</div>
<div class="viewcode-block" id="KataPlugin.get_helpers"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.get_helpers">[docs]</a>    <span class="k">def</span> <span class="nf">get_helpers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Register helpers &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;get_authors&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_authors</span><span class="p">,</span>
                <span class="s">&#39;get_contact&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_contact</span><span class="p">,</span>
                <span class="s">&#39;get_dict_field_errors&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_dict_field_errors</span><span class="p">,</span>
                <span class="s">&#39;get_distributor&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_distributor</span><span class="p">,</span>
                <span class="s">&#39;get_funder&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_funder</span><span class="p">,</span>
                <span class="s">&#39;get_funders&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_funders</span><span class="p">,</span>
                <span class="s">&#39;get_owner&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_owner</span><span class="p">,</span>
                <span class="s">&#39;get_package_ratings&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_package_ratings</span><span class="p">,</span>
                <span class="s">&#39;get_package_ratings_for_data_dict&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_package_ratings_for_data_dict</span><span class="p">,</span>
                <span class="s">&#39;has_agents_field&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">has_agents_field</span><span class="p">,</span>
                <span class="s">&#39;has_contacts_field&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">has_contacts_field</span><span class="p">,</span>
                <span class="s">&#39;kata_sorted_extras&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">kata_sorted_extras</span><span class="p">,</span>
                <span class="s">&#39;reference_update&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reference_update</span><span class="p">,</span>
                <span class="s">&#39;resolve_agent_role&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">resolve_agent_role</span><span class="p">,</span>
                <span class="s">&#39;get_related_urls&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_related_urls</span><span class="p">,</span>
                <span class="s">&#39;get_rdf_extras&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_rdf_extras</span><span class="p">,</span>
                <span class="s">&#39;get_if_url&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_if_url</span><span class="p">,</span>
                <span class="s">&#39;string_to_list&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">string_to_list</span><span class="p">,</span>
                <span class="s">&#39;get_first_admin&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_first_admin</span><span class="p">,</span>
                <span class="s">&#39;get_rightscategory&#39;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_rightscategory</span><span class="p">,</span>
                <span class="p">}</span>
</div>
<div class="viewcode-block" id="KataPlugin.get_dict_field_errors"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.get_dict_field_errors">[docs]</a>    <span class="k">def</span> <span class="nf">get_dict_field_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get errors correctly for fields that are represented as nested dict fields in data_dict.</span>

<span class="sd">        :param errors: errors dictionary</span>
<span class="sd">        :param field: field name</span>
<span class="sd">        :param index: index</span>
<span class="sd">        :param name:</span>
<span class="sd">        :returns: `[u&#39;error1&#39;, u&#39;error2&#39;]`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">error_dict</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error_dict</span> <span class="ow">and</span> <span class="n">error_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">error_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error</span>

    <span class="c"># Todo: some of these can be found from helpers, too. This shouldn&#39;t be</span></div>
<div class="viewcode-block" id="KataPlugin.has_agents_field"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.has_agents_field">[docs]</a>    <span class="k">def</span> <span class="nf">has_agents_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return true if some of the data dict&#39;s agents has attribute given in field.</span>

<span class="sd">        :rtype: boolean</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[]</span> <span class="o">!=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;agent&#39;</span><span class="p">,</span> <span class="p">[]))</span>
</div>
<div class="viewcode-block" id="KataPlugin.has_contacts_field"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.has_contacts_field">[docs]</a>    <span class="k">def</span> <span class="nf">has_contacts_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return true if some of the data dict&#39;s contacts has attribute given in field&#39;.</span>

<span class="sd">        :rtype: boolean</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[]</span> <span class="o">!=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contact&#39;</span><span class="p">,</span> <span class="p">[]))</span>
</div>
<div class="viewcode-block" id="KataPlugin.reference_update"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.reference_update">[docs]</a>    <span class="k">def</span> <span class="nf">reference_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
        <span class="c"># Todo: this can be found from helpers as well!</span>
        <span class="c">#@beaker_cache(type=&quot;dbm&quot;, expire=2678400)</span>
        <span class="k">def</span> <span class="nf">cached_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">url</span>
        <span class="k">return</span> <span class="n">cached_url</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KataPlugin.is_custom_form"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.is_custom_form">[docs]</a>    <span class="k">def</span> <span class="nf">is_custom_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Template helper, used to identify ckan custom form</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_extras_form</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_dict</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="KataPlugin.kata_sorted_extras"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.kata_sorted_extras">[docs]</a>    <span class="k">def</span> <span class="nf">kata_sorted_extras</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Used for outputting package extras, skips `package_hide_extras`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">extra</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;deleted&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c"># Todo: the AND makes no sense. Isn&#39;t this in helpers too?</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">extra</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">],</span> <span class="n">extra</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">package_hide_extras</span> <span class="ow">and</span>\
                <span class="n">key</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">KATA_FIELDS</span> <span class="ow">and</span>\
                <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;author_&#39;</span><span class="p">)</span> <span class="ow">and</span>\
                <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;organization_&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="k">if</span>  <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;title_&#39;</span><span class="p">)</span> <span class="ow">or</span>\
                <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;lang_title_&#39;</span><span class="p">)</span> <span class="ow">or</span>\
                <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;harvest_object_id&#39;</span> <span class="ow">or</span>\
                <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;harvest_source_id&#39;</span> <span class="ow">or</span>\
                <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;harvest_source_title&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">package_hide_extras</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">extra</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">_key</span><span class="p">):</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">unicode</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output</span>
</div>
<div class="viewcode-block" id="KataPlugin.update_config"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.update_config">[docs]</a>    <span class="k">def</span> <span class="nf">update_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This IConfigurer implementation causes CKAN to look in the</span>
<span class="sd">        `templates` directory when looking for the `package_form()`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">toolkit</span><span class="o">.</span><span class="n">add_template_directory</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">&#39;theme/templates&#39;</span><span class="p">)</span>
        <span class="n">toolkit</span><span class="o">.</span><span class="n">add_public_directory</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">&#39;theme/public&#39;</span><span class="p">)</span>
        <span class="n">toolkit</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="s">&#39;theme/public&#39;</span><span class="p">,</span> <span class="s">&#39;kata-resources&#39;</span><span class="p">)</span>      <span class="c"># Fanstatic resource library</span>

        <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
        <span class="n">rootdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">here</span><span class="p">))</span>

        <span class="n">roles</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;kata.contact_roles&#39;</span><span class="p">,</span> <span class="s">&#39;Please, Configure&#39;</span><span class="p">)</span>
        <span class="n">config</span><span class="p">[</span><span class="s">&#39;package_hide_extras&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">KATA_FIELDS</span><span class="p">)</span>
        <span class="n">config</span><span class="p">[</span><span class="s">&#39;ckan.i18n_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rootdir</span><span class="p">,</span> <span class="s">&#39;ckanext&#39;</span><span class="p">,</span> <span class="s">&#39;kata&#39;</span><span class="p">)</span>
        <span class="n">roles</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roles</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="n">roles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_extras_form</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;kata.hide_extras_form&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># This controls the operation of the CKAN search indexing. If you don&#39;t define this option</span>
            <span class="c"># then indexing is on. You will want to turn this off if you have a non-synchronous search</span>
            <span class="c"># index extension installed.</span>
            <span class="n">unload</span><span class="p">(</span><span class="s">&#39;synchronous_search&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Disabled synchronous search&quot;</span><span class="p">)</span>
            <span class="c"># Note: in CKAN 2.2, disabling this plugin causes other plugins to be reloaded</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Failed to disable synchronous search!&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KataPlugin.package_types"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.package_types">[docs]</a>    <span class="k">def</span> <span class="nf">package_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return an iterable of package types that this plugin handles.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">&#39;dataset&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="KataPlugin.is_fallback"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.is_fallback">[docs]</a>    <span class="k">def</span> <span class="nf">is_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Overrides ``IDatasetForm.is_fallback()``</span>
<span class="sd">        From CKAN documentation:  &quot;Returns true iff this provides the fallback behaviour,</span>
<span class="sd">        when no other plugin instance matches a package&#39;s type.&quot;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="KataPlugin.configure"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Pass configuration to plugins and extensions.</span>
<span class="sd">        Called by load_environment.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_format</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;kata.date_format&#39;</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KataPlugin.setup_template_variables"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.setup_template_variables">[docs]</a>    <span class="k">def</span> <span class="nf">setup_template_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override ``DefaultDatasetForm.setup_template_variables()`` form  method from :file:`ckan.lib.plugins.py`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">KataPlugin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setup_template_variables</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span>
        <span class="n">c</span><span class="o">.</span><span class="n">lastmod</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KataPlugin.new_template"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.new_template">[docs]</a>    <span class="k">def</span> <span class="nf">new_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return location of the add dataset page&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;package/new.html&#39;</span>
</div>
<div class="viewcode-block" id="KataPlugin.comments_template"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.comments_template">[docs]</a>    <span class="k">def</span> <span class="nf">comments_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return location of the package comments page&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;package/comments.html&#39;</span>
</div>
<div class="viewcode-block" id="KataPlugin.search_template"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.search_template">[docs]</a>    <span class="k">def</span> <span class="nf">search_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return location of the package search page&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;package/search.html&#39;</span>
</div>
<div class="viewcode-block" id="KataPlugin.read_template"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.read_template">[docs]</a>    <span class="k">def</span> <span class="nf">read_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return location of the package read page&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;package/read.html&#39;</span>
</div>
<div class="viewcode-block" id="KataPlugin.history_template"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.history_template">[docs]</a>    <span class="k">def</span> <span class="nf">history_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return location of the package history page&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;package/history.html&#39;</span>
</div>
<div class="viewcode-block" id="KataPlugin.package_form"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.package_form">[docs]</a>    <span class="k">def</span> <span class="nf">package_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return location of the main package page&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;package/new_package_form.html&#39;</span>
</div>
<div class="viewcode-block" id="KataPlugin.dataset_facets"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.dataset_facets">[docs]</a>    <span class="k">def</span> <span class="nf">dataset_facets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">facets_dict</span><span class="p">,</span> <span class="n">package_type</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the dictionary mapping facet names to facet titles.</span>
<span class="sd">        The dict supplied is actually an ordered dict.</span>

<span class="sd">        Example: ``{&#39;facet_name&#39;: &#39;The title of the facet&#39;}``</span>

<span class="sd">        :param facets_dict: the facets dictionary</span>
<span class="sd">        :param package_type: eg. `dataset`</span>
<span class="sd">        :returns: the modified facets_dict</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_field_titles</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">_</span><span class="p">)</span>
        <span class="n">kata_facet_titles</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="n">titles</span><span class="p">[</span><span class="n">field</span><span class="p">])</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">FACETS</span><span class="p">)</span>

        <span class="c"># Replace the facet dictionary with Kata facets.</span>
        <span class="c"># CKAN adds &#39;Groups&#39; and &#39;Formats&#39; there which we don&#39;t want.</span>
        <span class="c"># /harvest page has a &#39;Frequency&#39; facet which we lose also when replacing the dict here.</span>

        <span class="c"># facets_dict.update(kata_facet_titles)</span>
        <span class="n">facets_dict</span> <span class="o">=</span> <span class="n">kata_facet_titles</span>
        <span class="k">return</span> <span class="n">facets_dict</span>
</div>
<div class="viewcode-block" id="KataPlugin.extract_search_params"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.extract_search_params">[docs]</a>    <span class="k">def</span> <span class="nf">extract_search_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts parameters beginning with ``ext_`` from `data_dict[&#39;extras&#39;]`</span>
<span class="sd">        for advanced search.</span>

<span class="sd">        :param data_dict: contains all parameters from search.html</span>
<span class="sd">        :rtype: unordered lists extra_terms and extra_ops, dict extra_dates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extra_terms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extra_ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extra_dates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">extra_advanced_search</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># Extract parameters</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;extras&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="c"># Extract search operators</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ext_operator&#39;</span><span class="p">):</span>
                    <span class="n">extra_ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="c"># Extract search date limits from eg.</span>
                <span class="c"># name = &quot;ext_date-metadata_modified-start&quot;</span>
                <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ext_date&#39;</span><span class="p">):</span>
                    <span class="n">param_tokens</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">extra_dates</span><span class="p">[</span><span class="n">param_tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c"># &#39;start&#39; or &#39;end&#39; date</span>
                    <span class="n">extra_dates</span><span class="p">[</span><span class="s">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">param</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ext_advanced-search&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">extra_advanced_search</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># Extract search terms</span>
                    <span class="n">extra_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">extra_terms</span><span class="p">,</span> <span class="n">extra_ops</span><span class="p">,</span> <span class="n">extra_dates</span><span class="p">,</span> <span class="n">extra_advanced_search</span>
</div>
<div class="viewcode-block" id="KataPlugin.parse_search_terms"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.parse_search_terms">[docs]</a>    <span class="k">def</span> <span class="nf">parse_search_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">extra_terms</span><span class="p">,</span> <span class="n">extra_ops</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse extra terms and operators into query q into data_dict:</span>
<span class="sd">        `data_dict[&#39;q&#39;]: ((author:*onstabl*) OR (title:*edliest jok* AND</span>
<span class="sd">        tags:*somekeyword*) OR (title:sometitle NOT tags:*otherkeyword*))`</span>
<span class="sd">        Note that all ANDs and NOTs are enclosed in parenthesis by ORs.</span>
<span class="sd">        Outer parenthesis are for date limits to work correctly.</span>

<span class="sd">        :param data_dict: full data_dict from package:search</span>
<span class="sd">        :param extra_terms: `[(ext_organization-2, u&#39;someOrg&#39;), ...]`</span>
<span class="sd">        :param extra_ops: `[(ext_operator-2, u&#39;AND&#39;), ...]`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">extras_cmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="n">a</span>  <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">b</span>  <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">:</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>

        <span class="n">extra_terms</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">cmp</span><span class="o">=</span><span class="n">extras_cmp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tpl</span><span class="p">:</span> <span class="n">tpl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">extra_ops</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">cmp</span><span class="o">=</span><span class="n">extras_cmp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tpl</span><span class="p">:</span> <span class="n">tpl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">c</span><span class="o">.</span><span class="n">current_search_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># Handle first search term row</span>
        <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="n">extra_terms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p_no_index</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39; ((</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p_no_index</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="n">value</span><span class="p">)</span>  <span class="c"># Add field search to query q</span>
        <span class="n">c</span><span class="o">.</span><span class="n">current_search_rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;field&#39;</span><span class="p">:</span> <span class="n">p_no_index</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">extra_terms</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_ops</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="p">(</span><span class="n">oparam</span><span class="p">,</span> <span class="n">ovalue</span><span class="p">)</span> <span class="o">=</span> <span class="n">extra_ops</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
            <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="n">extra_terms</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p_no_index</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ovalue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;AND&#39;</span><span class="p">,</span> <span class="s">&#39;NOT&#39;</span><span class="p">]:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ovalue</span>  <span class="c"># Add operator (AND / NOT)</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39; </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p_no_index</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="n">value</span><span class="p">)</span>  <span class="c"># Add field search to query q</span>
            <span class="k">elif</span> <span class="n">ovalue</span> <span class="o">==</span> <span class="s">&#39;OR&#39;</span><span class="p">:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;) </span><span class="si">%s</span><span class="s"> (&#39;</span> <span class="o">%</span> <span class="n">ovalue</span>  <span class="c"># Add operator OR</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39; </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p_no_index</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="n">value</span><span class="p">)</span>  <span class="c"># Add field search to query q</span>
            <span class="n">c</span><span class="o">.</span><span class="n">current_search_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s">&#39;field&#39;</span><span class="p">:</span><span class="n">p_no_index</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">:</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;operator&#39;</span><span class="p">:</span><span class="n">ovalue</span><span class="p">})</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;))&#39;</span>
</div>
<div class="viewcode-block" id="KataPlugin.parse_search_dates"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.parse_search_dates">[docs]</a>    <span class="k">def</span> <span class="nf">parse_search_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">extra_dates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse extra date into query q into data_dict:</span>
<span class="sd">        `data_dict[&#39;q&#39;]: ((author:*onstabl*) OR (title:*edliest jok* AND</span>
<span class="sd">        tags:*somekeyword*) OR (title:sometitle NOT tags:*otherkeyword*)) AND</span>
<span class="sd">        metadata_modified:[1900-01-01T00:00:00.000Z TO 2000-12-31T23:59:59.999Z]`</span>

<span class="sd">        :param data_dict: full data_dict from package:search</span>
<span class="sd">        :param extra_dates: ``{&#39;start&#39;: 1991,</span>
<span class="sd">                             &#39;end&#39;: 1994,</span>
<span class="sd">                             &#39;field&#39;: &#39;metadata_modified&#39;}``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">current_search_limiters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39; AND &#39;</span>
        <span class="n">qdate</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">extra_dates</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;start&#39;</span><span class="p">):</span>
            <span class="n">qdate</span> <span class="o">+=</span> <span class="s">&#39;[&#39;</span> <span class="o">+</span> <span class="n">extra_dates</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;-01-01T00:00:00.000Z TO &#39;</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;ext_date-&#39;</span> <span class="o">+</span> <span class="n">extra_dates</span><span class="p">[</span><span class="s">&#39;field&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;-start&#39;</span>
            <span class="n">c</span><span class="o">.</span><span class="n">current_search_limiters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_dates</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qdate</span> <span class="o">+=</span> <span class="s">&#39;[* TO &#39;</span>
        <span class="k">if</span> <span class="n">extra_dates</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;end&#39;</span><span class="p">):</span>
            <span class="n">qdate</span> <span class="o">+=</span> <span class="n">extra_dates</span><span class="p">[</span><span class="s">&#39;end&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;-12-31T23:59:59.999Z]&#39;</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;ext_date-&#39;</span> <span class="o">+</span> <span class="n">extra_dates</span><span class="p">[</span><span class="s">&#39;field&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;-end&#39;</span>
            <span class="n">c</span><span class="o">.</span><span class="n">current_search_limiters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_dates</span><span class="p">[</span><span class="s">&#39;end&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qdate</span> <span class="o">+=</span> <span class="s">&#39;*]&#39;</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;q&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39; </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">extra_dates</span><span class="p">[</span><span class="s">&#39;field&#39;</span><span class="p">],</span> <span class="n">qdate</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KataPlugin.before_search"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.before_search">[docs]</a>    <span class="k">def</span> <span class="nf">before_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Things to do before querying Solr. Basically used by</span>
<span class="sd">        the advanced search feature.</span>

<span class="sd">        :param data_dict: data_dict to modify</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;sort&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;sort&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;sort&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_SORT_BY</span>
            <span class="n">c</span><span class="o">.</span><span class="n">sort_by_selected</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEFAULT_SORT_BY</span>  <span class="c"># This is to get the correct one pre-selected on the HTML form.</span>

        <span class="n">c</span><span class="o">.</span><span class="n">search_fields</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SEARCH_FIELDS</span>
        <span class="n">c</span><span class="o">.</span><span class="n">translated_field_titles</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_field_titles</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">_</span><span class="p">)</span>

        <span class="c"># Start advanced search parameter parsing</span>
        <span class="k">if</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;extras&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;extras&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#log.debug(&quot;before_search(): data_dict[&#39;extras&#39;]: %r&quot; %</span>
            <span class="c">#          data_dict[&#39;extras&#39;].items())</span>

            <span class="n">extra_terms</span><span class="p">,</span> <span class="n">extra_ops</span><span class="p">,</span> <span class="n">extra_dates</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">advanced_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_search_params</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>
            <span class="c">#log.debug(&quot;before_search(): extra_terms: %r; extra_ops: %r; &quot;</span>
            <span class="c">#          + &quot;extra_dates: %r&quot;, extra_terms, extra_ops, extra_dates)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_terms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_search_terms</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">extra_terms</span><span class="p">,</span> <span class="n">extra_ops</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_dates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_search_dates</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">extra_dates</span><span class="p">)</span>

            <span class="c">#log.debug(&quot;before_search(): c.current_search_rows: %s; \</span>
            <span class="c">#    c.current_search_limiters: %s&quot; % (c.current_search_rows,</span>
            <span class="c">#    c.current_search_limiters))</span>
        <span class="c"># End advanced search parameter parsing</span>

        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;facet.field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FACETS</span>

        <span class="c">#log.debug(&quot;before_search(): data_dict: %r&quot; % data_dict)</span>
        <span class="c"># Uncomment below to show query with results and in the search field</span>
        <span class="c">#c.q = data_dict[&#39;q&#39;]</span>

        <span class="c"># Log non-empty search queries and constraints (facets)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;q&#39;</span><span class="p">)</span>
        <span class="n">fq</span> <span class="o">=</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;fq&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">q</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fq</span> <span class="ow">and</span> <span class="n">fq</span> <span class="o">!=</span> <span class="s">&#39;+dataset_type:dataset&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">u&quot;[{t}] Search query: {q};  constraints: {c}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">fq</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">data_dict</span>
</div>
<div class="viewcode-block" id="KataPlugin.before_index"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.plugin.KataPlugin.before_index">[docs]</a>    <span class="k">def</span> <span class="nf">before_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Modification to package dictionary before</span>
<span class="sd">        indexing it to Solr index. For example, we</span>
<span class="sd">        add resource mimetype to the index, modify</span>
<span class="sd">        agents and hide the email address</span>
<span class="sd">        </span>
<span class="sd">        :param pkg_dict: pkg_dict to modify</span>
<span class="sd">        :returns: the modified package dict to be indexed</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">EMAIL</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;.*contact_\d*_email&#39;</span><span class="p">)</span>

        <span class="c"># Add res_mimetype to pkg_dict. Can be removed after res_mimetype is</span>
        <span class="c"># added to CKAN&#39;s index function.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pkg_dict</span><span class="p">[</span><span class="s">&#39;data_dict&#39;</span><span class="p">])</span>
        <span class="n">res_mimetype</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resources&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">resource</span><span class="p">[</span><span class="s">&#39;mimetype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">res_mimetype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">u&#39;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_mimetype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resource</span><span class="p">[</span><span class="s">&#39;mimetype&#39;</span><span class="p">])</span>
        <span class="n">pkg_dict</span><span class="p">[</span><span class="s">&#39;res_mimetype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_mimetype</span>

        <span class="c"># Separate agent roles for Solr indexing</span>

        <span class="n">new_items</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pkg_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;agent&#39;</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;role&#39;</span><span class="p">:</span>
                <span class="n">role</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">role_idx</span> <span class="o">=</span> <span class="n">role</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">role_idx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">role_idx</span><span class="p">)</span>        <span class="c"># Must not be unicode</span>
                <span class="n">org_idx</span> <span class="o">=</span> <span class="s">&#39;organization_&#39;</span> <span class="o">+</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">agent_name</span> <span class="o">=</span> <span class="n">pkg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;name&#39;</span><span class="p">)),</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">agent_org</span> <span class="o">=</span> <span class="n">pkg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;organisation&#39;</span><span class="p">)),</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">agent_id</span> <span class="o">=</span> <span class="n">pkg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;id&#39;</span><span class="p">)),</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

                <span class="n">new_items</span><span class="p">[</span><span class="n">role_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_name</span>
                <span class="n">new_items</span><span class="p">[</span><span class="n">org_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_org</span>
                <span class="n">new_items</span><span class="p">[</span><span class="s">&#39;agent_name_&#39;</span> <span class="o">+</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">agent_name</span>
                <span class="n">new_items</span><span class="p">[</span><span class="s">&#39;agent_name_&#39;</span> <span class="o">+</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;_org&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_org</span>
                <span class="n">new_items</span><span class="p">[</span><span class="s">&#39;agent_name_&#39;</span> <span class="o">+</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_id</span>
            
            <span class="c"># hide sensitive data</span>
            <span class="k">if</span> <span class="n">EMAIL</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">pkg_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&#39;&#39;</span>

        <span class="n">pkg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_items</span><span class="p">)</span>
        
        <span class="c"># hide sensitive data</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;extras&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">EMAIL</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]):</span>
                <span class="n">item</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&#39;&#39;</span>

        <span class="n">pkg_dict</span><span class="p">[</span><span class="s">&#39;data_dict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pkg_dict</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="simple">
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="../../../search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../../genindex.html" title="General Index"
             >index</a>
        </div>

        <div class="right">
          
    <div class="footer">
        &copy; Copyright 2014, CSC.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>