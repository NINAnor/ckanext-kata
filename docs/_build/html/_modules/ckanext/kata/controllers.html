<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ckanext.kata.controllers &mdash; Kata metadata catalogue documentation</title>
    
    <link rel="stylesheet" href="../../../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Kata metadata catalogue documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="../../../index.html">Kata</a></div>
        <div class="rel">
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ckanext.kata.controllers</h1><div class="highlight"><pre>
<span class="c"># coding=utf8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Controllers for Kata.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">cgi</span> <span class="kn">import</span> <span class="n">FieldStorage</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functionally</span> <span class="kn">as</span> <span class="nn">fn</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">select</span>

<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>

<span class="kn">from</span> <span class="nn">paste.deploy.converters</span> <span class="kn">import</span> <span class="n">asbool</span>
<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">response</span>
<span class="kn">from</span> <span class="nn">pylons.decorators.cache</span> <span class="kn">import</span> <span class="n">beaker_cache</span>
<span class="kn">from</span> <span class="nn">pylons.i18n</span> <span class="kn">import</span> <span class="n">_</span>

<span class="kn">from</span> <span class="nn">ckan.controllers.api</span> <span class="kn">import</span> <span class="n">ApiController</span>
<span class="kn">from</span> <span class="nn">ckan.controllers.package</span> <span class="kn">import</span> <span class="n">PackageController</span>
<span class="kn">from</span> <span class="nn">ckan.controllers.user</span> <span class="kn">import</span> <span class="n">UserController</span>
<span class="kn">from</span> <span class="nn">ckan.controllers.storage</span> <span class="kn">import</span> <span class="n">StorageController</span>
<span class="kn">import</span> <span class="nn">ckan.lib.i18n</span>
<span class="kn">from</span> <span class="nn">ckan.lib.base</span> <span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">ckan.lib.email_notifications</span> <span class="kn">import</span> <span class="n">send_notification</span>
<span class="kn">from</span> <span class="nn">ckan.lib</span> <span class="kn">import</span> <span class="n">captcha</span><span class="p">,</span> <span class="n">helpers</span>
<span class="kn">from</span> <span class="nn">ckan.logic</span> <span class="kn">import</span> <span class="n">get_action</span><span class="p">,</span> <span class="n">NotAuthorized</span><span class="p">,</span> <span class="n">NotFound</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">import</span> <span class="nn">ckan.logic</span> <span class="kn">as</span> <span class="nn">logic</span>
<span class="kn">import</span> <span class="nn">ckan.model</span> <span class="kn">as</span> <span class="nn">model</span>
<span class="kn">from</span> <span class="nn">ckan.model</span> <span class="kn">import</span> <span class="n">Package</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">ckan.model.authz</span> <span class="kn">import</span> <span class="n">add_user_to_role</span>
<span class="kn">import</span> <span class="nn">ckan.plugins</span> <span class="kn">as</span> <span class="nn">plugins</span>

<span class="kn">import</span> <span class="nn">ckanext.harvest.interfaces</span> <span class="kn">as</span> <span class="nn">h_interfaces</span>
<span class="kn">from</span> <span class="nn">ckanext.kata.model</span> <span class="kn">import</span> <span class="n">KataAccessRequest</span>
<span class="kn">import</span> <span class="nn">ckanext.kata.clamd_wrapper</span> <span class="kn">as</span> <span class="nn">clamd_wrapper</span>
<span class="kn">from</span> <span class="nn">ckanext.kata</span> <span class="kn">import</span> <span class="n">utils</span>

<span class="n">_get_or_bust</span> <span class="o">=</span> <span class="n">ckan</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">get_or_bust</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">plugins</span><span class="o">.</span><span class="n">toolkit</span>                         <span class="c"># pylint: disable=invalid-name</span>


<div class="viewcode-block" id="get_package_owner"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.get_package_owner">[docs]</a><span class="k">def</span> <span class="nf">get_package_owner</span><span class="p">(</span><span class="n">package</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the user id of the package admin for the specified package.</span>
<span class="sd">       If multiple user accounts are associated with the package as admins,</span>
<span class="sd">       an arbitrary one is returned.</span>

<span class="sd">       :param package: package data</span>
<span class="sd">       :type package: dictionary</span>
<span class="sd">       :returns: userid</span>
<span class="sd">       :rtype: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">userid</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">package</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">role</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s">&quot;admin&quot;</span><span class="p">:</span>
            <span class="n">userid</span> <span class="o">=</span> <span class="n">role</span><span class="o">.</span><span class="n">user_id</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">userid</span>

</div>
<div class="viewcode-block" id="MetadataController"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.MetadataController">[docs]</a><span class="k">class</span> <span class="nc">MetadataController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    URN export</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_urnexport</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uncached urnexport, needed for testing.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">_or_</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">or_</span>
        <span class="n">_and_</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">and_</span>

        <span class="n">xmlns</span> <span class="o">=</span> <span class="s">&quot;urn:nbn:se:uu:ub:epc-schema:rs-location-mapping&quot;</span>
        <span class="k">def</span> <span class="nf">locns</span><span class="p">(</span><span class="n">loc</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;{</span><span class="si">%s</span><span class="s">}</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xmlns</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
        <span class="n">xsi</span> <span class="o">=</span> <span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
        <span class="n">schemalocation</span> <span class="o">=</span> <span class="s">&quot;urn:nbn:se:uu:ub:epc-schema:rs-location-mapping &quot;</span> \
                         <span class="s">&quot;http://urn.kb.se/resolve?urn=urn:nbn:se:uu:ub:epc-schema:rs-location-mapping&amp;godirectly&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&quot;{&quot;</span> <span class="o">+</span> <span class="n">xmlns</span> <span class="o">+</span> <span class="s">&quot;}records&quot;</span><span class="p">,</span>
                         <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;{&quot;</span> <span class="o">+</span> <span class="n">xsi</span> <span class="o">+</span> <span class="s">&quot;}schemaLocation&quot;</span><span class="p">:</span> <span class="n">schemalocation</span><span class="p">},</span>
                         <span class="n">nsmap</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;xsi&#39;</span><span class="p">:</span> <span class="n">xsi</span><span class="p">,</span> <span class="bp">None</span><span class="p">:</span> <span class="n">xmlns</span><span class="p">})</span>

        <span class="c"># Gather all package id&#39;s that might contain a Kata/IDA data PID</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">PackageExtra</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">PackageExtra</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">&#39;pids_%_id&#39;</span><span class="p">))</span><span class="o">.</span> \
            <span class="nb">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">PackageExtra</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">&#39;urn:nbn:fi:csc-%&#39;</span><span class="p">))</span><span class="o">.</span> \
            <span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Package</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Package</span><span class="o">.</span><span class="n">private</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Package</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s">&#39;active&#39;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">values</span><span class="p">(</span><span class="s">&#39;package_id&#39;</span><span class="p">)</span>

        <span class="n">base_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ckan.site_url&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>

        <span class="n">prot</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">locns</span><span class="p">(</span><span class="s">&#39;protocol-version&#39;</span><span class="p">))</span>
        <span class="n">prot</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&#39;3.0&#39;</span>
        <span class="n">datestmp</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">locns</span><span class="p">(</span><span class="s">&#39;datestamp&#39;</span><span class="p">),</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;modified&#39;</span><span class="p">})</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">datestmp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">now</span>
        <span class="k">for</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="s">&#39;package_show&#39;</span><span class="p">)({},</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">pkg_id</span><span class="p">})</span>
            <span class="c"># Get primary data PID and make sure we want to display this dataset</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_pid</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pids_by_type</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">primary</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">data_pid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;urn:nbn:fi:csc-&#39;</span><span class="p">):</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">locns</span><span class="p">(</span><span class="s">&#39;record&#39;</span><span class="p">))</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">locns</span><span class="p">(</span><span class="s">&#39;header&#39;</span><span class="p">))</span>
                <span class="n">datestmp</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">locns</span><span class="p">(</span><span class="s">&#39;datestamp&#39;</span><span class="p">),</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;modified&#39;</span><span class="p">})</span>
                <span class="n">datestmp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">now</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">locns</span><span class="p">(</span><span class="s">&#39;identifier&#39;</span><span class="p">))</span>
                <span class="n">identifier</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">data_pid</span>
                <span class="n">destinations</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">locns</span><span class="p">(</span><span class="s">&#39;destinations&#39;</span><span class="p">))</span>
                <span class="n">destination</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">destinations</span><span class="p">,</span> <span class="n">locns</span><span class="p">(</span><span class="s">&#39;destination&#39;</span><span class="p">),</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;activated&#39;</span><span class="p">})</span>
                <span class="n">datestamp</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">locns</span><span class="p">(</span><span class="s">&#39;datestamp&#39;</span><span class="p">),</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;activated&#39;</span><span class="p">})</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">locns</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">))</span>
                <span class="n">url</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_url</span><span class="p">,</span>
                                 <span class="n">helpers</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span>
                                           <span class="n">action</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">,</span>
                                           <span class="nb">id</span><span class="o">=</span><span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)))</span>
        <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;application/xml; charset=utf-8&#39;</span>
        <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">)</span>

    <span class="nd">@beaker_cache</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&quot;dbm&quot;</span><span class="p">,</span> <span class="n">expire</span><span class="o">=</span><span class="mi">86400</span><span class="p">)</span>
<div class="viewcode-block" id="MetadataController.urnexport"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.MetadataController.urnexport">[docs]</a>    <span class="k">def</span> <span class="nf">urnexport</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generate an XML listing of packages, which have Kata or Ida URN as data PID.</span>
<span class="sd">        Used by a third party service.</span>

<span class="sd">        :returns: An XML listing of packages and their URNs</span>
<span class="sd">        :rtype: string (xml)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_urnexport</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="KATAApiController"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KATAApiController">[docs]</a><span class="k">class</span> <span class="nc">KATAApiController</span><span class="p">(</span><span class="n">ApiController</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Functions for autocomplete fields in add dataset form</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="KATAApiController.media_type_autocomplete"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KATAApiController.media_type_autocomplete">[docs]</a>    <span class="k">def</span> <span class="nf">media_type_autocomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Suggestions for mimetype</span>

<span class="sd">        :rtype: dictionary</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;incomplete&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">known_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mimetypes</span><span class="o">.</span><span class="n">types_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span> <span class="n">type_label</span> <span class="k">for</span> <span class="n">type_label</span> <span class="ow">in</span> <span class="n">known_types</span> <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">type_label</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">]</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
        <span class="n">result_set</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;ResultSet&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;Result&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s">&#39;Name&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">}</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finish_ok</span><span class="p">(</span><span class="n">result_set</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KATAApiController.tag_autocomplete"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KATAApiController.tag_autocomplete">[docs]</a>    <span class="k">def</span> <span class="nf">tag_autocomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Suggestions for tags (keywords)</span>

<span class="sd">        :rtype: dictionary</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;incomplete&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onki_autocomplete</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s">&quot;koko&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KATAApiController.discipline_autocomplete"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KATAApiController.discipline_autocomplete">[docs]</a>    <span class="k">def</span> <span class="nf">discipline_autocomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Suggestions for discipline</span>

<span class="sd">        :rtype: dictionary</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;incomplete&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onki_autocomplete</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s">&quot;okm-tieteenala&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KATAApiController.location_autocomplete"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KATAApiController.location_autocomplete">[docs]</a>    <span class="k">def</span> <span class="nf">location_autocomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Suggestions for spatial coverage</span>

<span class="sd">        :rtype: dictionary</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;incomplete&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onki_autocomplete</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s">&quot;paikat&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_onki_autocomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Queries the remote ontology for suggestions and</span>
<span class="sd">        formats the data.</span>

<span class="sd">        :param query: the string to search for</span>
<span class="sd">        :type query: string</span>
<span class="sd">        :param vocab: the vocabulary/ontology</span>
<span class="sd">        :type vocab: string</span>

<span class="sd">        :rtype: dictionary</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">url_template</span> <span class="o">=</span> <span class="s">&quot;http://dev.finto.fi/rest/v1/search?query={q}*&amp;vocab={v}&quot;</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">vocab</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">jsondata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">u&#39;results&#39;</span> <span class="ow">in</span> <span class="n">jsondata</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">jsondata</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">concept</span><span class="p">[</span><span class="s">&#39;prefLabel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

        <span class="n">result_set</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;ResultSet&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;Result&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s">&#39;Name&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">}</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finish_ok</span><span class="p">(</span><span class="n">result_set</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="AccessRequestController"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.AccessRequestController">[docs]</a><span class="k">class</span> <span class="nc">AccessRequestController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    AccessRequestController class provides a feature to ask</span>
<span class="sd">    for editor rights to a dataset. On the other hand,</span>
<span class="sd">    it also provides the process to grant them upon request.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_have_pending_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns whether there are already pending requests</span>
<span class="sd">        from the given user regarding the given package.</span>

<span class="sd">        :param pkg_id: package id</span>
<span class="sd">        :type pkg_id: string</span>
<span class="sd">        :param user_id: user id</span>
<span class="sd">        :type user_id: string</span>

<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pending_requests</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">KataAccessRequest</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">KataAccessRequest</span><span class="o">.</span><span class="n">pkg_id</span> <span class="o">==</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">KataAccessRequest</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pending_requests</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>

<div class="viewcode-block" id="AccessRequestController.create_request"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.AccessRequestController.create_request">[docs]</a>    <span class="k">def</span> <span class="nf">create_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new editor access request in the database.</span>
<span class="sd">        Redirects the user to dataset view page</span>

<span class="sd">        :param pkg_id: package id</span>
<span class="sd">        :type pkg_id: string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pkg_id</span><span class="p">)</span>

        <span class="n">pkg</span> <span class="o">=</span> <span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Dataset not found&quot;</span><span class="p">))</span>

        <span class="n">pkg_title</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">title</span> <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">title</span> <span class="k">else</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_have_pending_requests</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">KataAccessRequest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">req</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_success</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;A request for editing privileges will be sent to the administrator of package </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">pkg_title</span><span class="p">)</span>
                <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;A request is already pending&quot;</span><span class="p">))</span>
                <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;You must be logged in to request edit access&quot;</span><span class="p">))</span>
            <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessRequestController.unlock_access"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.AccessRequestController.unlock_access">[docs]</a>    <span class="k">def</span> <span class="nf">unlock_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Adds a user to role editor for a dataset and</span>
<span class="sd">        redirects the user to dataset view page</span>

<span class="sd">        :param id: package id</span>
<span class="sd">        :type id: string</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">KataAccessRequest</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">req</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">pkg</span> <span class="o">=</span> <span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">)</span>
            <span class="n">pkg_title</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">title</span> <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">title</span> <span class="k">else</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span>
            <span class="n">add_user_to_role</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s">&#39;editor&#39;</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">pkg_id</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_success</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> now has editor rights to package </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pkg_title</span><span class="p">))</span>
            <span class="n">req</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;No such request found!&quot;</span><span class="p">))</span>
            <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessRequestController.render_edit_request"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.AccessRequestController.render_edit_request">[docs]</a>    <span class="k">def</span> <span class="nf">render_edit_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renders a page for requesting editor access to the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pkg_id</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">package</span> <span class="o">=</span> <span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">package</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Dataset not found&quot;</span><span class="p">))</span>

        <span class="n">c</span><span class="o">.</span><span class="n">package_owner</span> <span class="o">=</span> <span class="n">get_package_owner</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_have_pending_requests</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;contact/edit_request_form.html&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;A request is already pending&quot;</span><span class="p">))</span>
                <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;You must be logged in to request edit access&quot;</span><span class="p">))</span>
            <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="ContactController"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.ContactController">[docs]</a><span class="k">class</span> <span class="nc">ContactController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add features to contact the dataset&#39;s owner. </span>
<span class="sd">    </span>
<span class="sd">    From the web page, this can be seen from the link telling that this dataset is accessible by contacting the author. </span>
<span class="sd">    The feature provides a form for message sending, and the message is sent via email.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_send_if_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">epilogue</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prologue</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a contact e-mail if allowed.</span>

<span class="sd">        All of the arguments should be unicode strings.</span>

<span class="sd">        :param pkg_id: package id</span>
<span class="sd">        :param subject: email&#39;s subject</span>
<span class="sd">        :param recipient: name of the recipient</span>
<span class="sd">        :param email: email address where the message is to be sent</span>
<span class="sd">        :param msg: the message to be sent</span>
<span class="sd">        :param prologue: message&#39;s prologue to be included before the user&#39;s message (optional)</span>
<span class="sd">        :param epilogue: message&#39;s epilogue to be included after the user&#39;s message (optional)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">package</span> <span class="o">=</span> <span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>

        <span class="n">prologue</span> <span class="o">=</span> <span class="n">prologue</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n\n\n</span><span class="s">&quot;</span> <span class="k">if</span> <span class="n">prologue</span> <span class="k">else</span> <span class="s">&quot;&quot;</span>
        <span class="n">epilogue</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n\n\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">epilogue</span> <span class="k">if</span> <span class="n">epilogue</span> <span class="k">else</span> <span class="s">&quot;&quot;</span>

        <span class="n">full_msg</span> <span class="o">=</span> <span class="s">u&quot;{a}{b}{c}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">prologue</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">epilogue</span><span class="p">)</span>
        <span class="n">email_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
                      <span class="s">&quot;body&quot;</span><span class="p">:</span> <span class="n">full_msg</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">recipient</span><span class="p">:</span>
            <span class="c"># fall back to using the email address as the name of the recipient</span>
            <span class="n">recipient</span> <span class="o">=</span> <span class="n">email</span>

        <span class="n">recipient_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;display_name&#39;</span><span class="p">:</span> <span class="n">recipient</span><span class="p">,</span> <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="n">email</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">send_notification</span><span class="p">(</span><span class="n">recipient_dict</span><span class="p">,</span> <span class="n">email_dict</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mark_package_as_contacted</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_notice</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Message sent&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;No message&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Please login&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_mark_package_as_contacted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userobj</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark this user as having already emailed the contact person of the package.&quot;&quot;&quot;</span>

        <span class="n">model</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">new_revision</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">&quot;contacted&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">userobj</span><span class="o">.</span><span class="n">extras</span><span class="p">:</span>
            <span class="n">userobj</span><span class="o">.</span><span class="n">extras</span><span class="p">[</span><span class="s">&#39;contacted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">userobj</span><span class="o">.</span><span class="n">extras</span><span class="p">[</span><span class="s">&#39;contacted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
        <span class="n">userobj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<div class="viewcode-block" id="ContactController.send_contact"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.ContactController.send_contact">[docs]</a>    <span class="k">def</span> <span class="nf">send_contact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Send a user message from CKAN to dataset distributor contact.</span>
<span class="sd">        Constructs the message and calls :meth:`_send_if_allowed`.</span>

<span class="sd">        Redirects the user to dataset view page.</span>

<span class="sd">        :param pkg_id: package id</span>
<span class="sd">        :type pkg_id: string</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># Todo: replan and fix when we have multiple distributor emails available</span>
        <span class="c"># This only works because we have only one contact</span>
        <span class="n">prologue_template</span> <span class="o">=</span> <span class="s">u&#39;{a} ({b}) has sent you a message regarding the following dataset:</span><span class="se">\</span>
<span class="se">\n\n</span><span class="s">{c} (Identifier: {d})</span><span class="se">\n\n</span><span class="s">The message is below.</span><span class="se">\n\n</span><span class="s">{a} ({b}) on lähettänyt sinulle viestin koskien tietoaineistoa:</span><span class="se">\</span>
<span class="se">\n\n</span><span class="s">{c} (Tunniste: {d})</span><span class="se">\n\n</span><span class="s">Viesti:</span><span class="se">\n\n</span><span class="s">    ---&#39;</span>

        <span class="n">epilogue</span> <span class="o">=</span> <span class="s">u&#39;    ---</span><span class="se">\</span>
<span class="se">\n\n</span><span class="s">Please do not reply directly to this e-mail.</span><span class="se">\</span>
<span class="se">\n</span><span class="s">If you need to reply to the sender, use the direct e-mail address above.</span><span class="se">\</span>
<span class="se">\n\n</span><span class="s">Älä vastaa suoraan tähän viestiin. Jos vastaat lähettäjälle, </span><span class="se">\</span>
<span class="s">käytä yllä olevaa sähköpostiosoitetta.&#39;</span>

        <span class="n">package</span> <span class="o">=</span> <span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
        <span class="n">package_title</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">title</span> <span class="k">if</span> <span class="n">package</span><span class="o">.</span><span class="n">title</span> <span class="k">else</span> <span class="n">package</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="p">:</span>
            <span class="n">user_name</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">fullname</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">fullname</span> <span class="k">else</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">name</span>

            <span class="n">email</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_package_contact_email</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
            <span class="n">recipient</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_package_contact_name</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>

            <span class="n">user_msg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;msg&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">prologue</span> <span class="o">=</span> <span class="n">prologue_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">user_name</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">package_title</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">package</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;Message regarding dataset / Viesti koskien tietoaineistoa </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">package_title</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_if_allowed</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">user_msg</span><span class="p">,</span> <span class="n">epilogue</span><span class="p">,</span> <span class="n">prologue</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Please login&quot;</span><span class="p">))</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;read&quot;</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">package</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContactController.send_request"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.ContactController.send_request">[docs]</a>    <span class="k">def</span> <span class="nf">send_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Send a request to access data to CKAN dataset owner.</span>

<span class="sd">        Constructs the message and calls :meth:`_send_if_allowed`.</span>

<span class="sd">        Redirects the user to dataset view page.</span>

<span class="sd">        :param pkg_id: package id</span>
<span class="sd">        :type pkg_id: string</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">prologue_template</span> <span class="o">=</span> <span class="s">u&#39;{a} ({b}) is requesting access to data in dataset</span><span class="se">\n\n</span><span class="s">{c} (Identifier: {d})</span><span class="se">\n\n\</span>
<span class="s">for which you are currently marked as distributor.</span><span class="se">\n\n</span><span class="s">The message is below.</span><span class="se">\n\n\</span>
<span class="s">{a} ({b}) pyytää dataa, joka liittyy tietoaineistoon</span><span class="se">\n\n</span><span class="s">{c} (Tunniste: {d})</span><span class="se">\n\n</span><span class="s">ja johon sinut on merkitty jakelijaksi. </span><span class="se">\</span>
<span class="s">Mukaan liitetty viesti on alla.</span><span class="se">\n\n</span><span class="s">    ---&#39;</span>

        <span class="n">epilogue</span> <span class="o">=</span> <span class="s">u&#39;    ---</span><span class="se">\n\n</span><span class="s">Please do not reply directly to this e-mail.</span><span class="se">\n\</span>
<span class="s">If you need to reply to the sender, use the direct e-mail address above.</span><span class="se">\n\n\</span>
<span class="s">Älä vastaa suoraan tähän viestiin. Jos haluat lähettää viestin </span><span class="se">\</span>
<span class="s">lähettäjälle, käytä yllä olevaa sähköpostiosoitetta.&#39;</span>

        <span class="n">package</span> <span class="o">=</span> <span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
        <span class="n">package_title</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">title</span> <span class="k">if</span> <span class="n">package</span><span class="o">.</span><span class="n">title</span> <span class="k">else</span> <span class="n">package</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="p">:</span>
            <span class="n">user_name</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">fullname</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">fullname</span> <span class="k">else</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">name</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Attempting to send email (access request); user id = {u}, package = {p}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">pkg_id</span><span class="p">))</span>

            <span class="n">email</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_package_contact_email</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
            <span class="n">recipient</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_package_contact_name</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>

            <span class="n">user_msg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;msg&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">prologue</span> <span class="o">=</span> <span class="n">prologue_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">user_name</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">package_title</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">package</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">subject</span> <span class="o">=</span> <span class="s">u&quot;Data access request for dataset / Datapyyntö tietoaineistolle </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">package_title</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_if_allowed</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">recipient</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">user_msg</span><span class="p">,</span> <span class="n">epilogue</span><span class="p">,</span> <span class="n">prologue</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Please login&quot;</span><span class="p">))</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;read&quot;</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">package</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ContactController.render_contact"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.ContactController.render_contact">[docs]</a>    <span class="k">def</span> <span class="nf">render_contact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Render the contact form if allowed.</span>

<span class="sd">        :param pkg_id: package id</span>
<span class="sd">        :type pkg_id: string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span><span class="o">.</span><span class="n">package</span> <span class="o">=</span> <span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">package</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Dataset not found&quot;</span><span class="p">))</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;read&quot;</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contacted&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;contact/contact_form.html&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Already contacted&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Please login&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContactController.render_request"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.ContactController.render_request">[docs]</a>    <span class="k">def</span> <span class="nf">render_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Render the access request contact form if allowed.</span>

<span class="sd">        :param pkg_id: package id</span>
<span class="sd">        :type pkg_id: string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span><span class="o">.</span><span class="n">package</span> <span class="o">=</span> <span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg_id</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;read&quot;</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkg_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contacted&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;contact/dataset_request_form.html&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Already contacted&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Please login&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="KataUserController"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KataUserController">[docs]</a><span class="k">class</span> <span class="nc">KataUserController</span><span class="p">(</span><span class="n">UserController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overwrite logged_in function in the super class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="KataUserController.logged_in"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KataUserController.logged_in">[docs]</a>    <span class="k">def</span> <span class="nf">logged_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Minor rewrite to redirect the user to the own profile page instead of</span>
<span class="sd">        the dashboard.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># we need to set the language via a redirect</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;lang&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">came_from</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;came_from&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="c"># we need to set the language explicitly here or the flash</span>
        <span class="c"># messages will not be translated.</span>
        <span class="n">ckan</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">i18n</span><span class="o">.</span><span class="n">set_lang</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">url_is_local</span><span class="p">(</span><span class="n">came_from</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">came_from</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                       <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">}</span>

            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">}</span>

            <span class="n">user_dict</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="s">&#39;user_show&#39;</span><span class="p">)(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>

            <span class="c">#h.flash_success(_(&quot;%s is now logged in&quot;) %</span>
            <span class="c">#                user_dict[&#39;display_name&#39;])</span>
            <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;user&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Login failed. Bad username or password.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">openid_enabled</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">+=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39; (Or if using OpenID, it hasn</span><span class="se">\&#39;</span><span class="s">t been associated &#39;</span>
                         <span class="s">&#39;with a user account.)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">asbool</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ckan.legacy_templates&#39;</span><span class="p">,</span> <span class="s">&#39;false&#39;</span><span class="p">)):</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;user&#39;</span><span class="p">,</span>
                              <span class="n">action</span><span class="o">=</span><span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="n">came_from</span><span class="o">=</span><span class="n">came_from</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KataUserController.logged_out_page"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KataUserController.logged_out_page">[docs]</a>    <span class="k">def</span> <span class="nf">logged_out_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Redirect user to front page and inform user. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_notice</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Successfully logged out.&quot;</span><span class="p">))</span>
        <span class="n">h</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;home&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="KataPackageController"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KataPackageController">[docs]</a><span class="k">class</span> <span class="nc">KataPackageController</span><span class="p">(</span><span class="n">PackageController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds advanced search feature.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="KataPackageController.advanced_search"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KataPackageController.advanced_search">[docs]</a>    <span class="k">def</span> <span class="nf">advanced_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse query parameters from different search form inputs, modify into</span>
<span class="sd">        one query string &#39;q&#39; in the context and call basic :meth:`search` method of</span>
<span class="sd">        the super class.</span>

<span class="sd">        :returns: dictionary with keys results and count</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: Clean: Obsolete or move logging code elsewhere</span>
        <span class="c"># parse author search into q</span>
        <span class="n">q_author</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">q_author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;q_author&#39;</span><span class="p">,</span> <span class="s">u&#39;&#39;</span><span class="p">)</span>

        <span class="c"># unicode format (decoded from utf8)</span>
        <span class="n">q_free</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">q_free</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;q_free&#39;</span><span class="p">,</span> <span class="s">u&#39;&#39;</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q_free</span> <span class="o">+</span> <span class="s">u&#39; AND &#39;</span> <span class="o">+</span> <span class="s">u&#39;author:&#39;</span> <span class="o">+</span> <span class="n">q_author</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;advanced_search(): request.params.items(): </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="c">#log.debug(&#39;advanced_search(): q: %r&#39; % q)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;advanced_search(): call to search()&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="KataPackageController.dataset_editor_manage"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KataPackageController.dataset_editor_manage">[docs]</a>    <span class="k">def</span> <span class="nf">dataset_editor_manage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Manages (adds) editors and admins of a dataset and sends an invitation email</span>
<span class="sd">        if wanted in case user has not yet logged in to the service.</span>
<span class="sd">        The invitation email feature has no automatic features bound to it, it is a</span>
<span class="sd">        plain email sender.</span>

<span class="sd">        :param name: package name</span>
<span class="sd">        :type name: string</span>
<span class="sd">        :param username: if username (request.param) and role (request.param) are set, the user is added for the role</span>
<span class="sd">        :type username: string</span>
<span class="sd">        :param role: if username (request.param) and role (request.param) are set, the user is added for the role</span>
<span class="sd">        :type role: string</span>
<span class="sd">        :param email: if email address (request.param) is given, an invitation email is sent</span>
<span class="sd">        :type email: string</span>

<span class="sd">        Renders the package_administration page via :meth:`_show_dataset_role_page`</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="o">.</span><span class="n">check_access</span><span class="p">(</span><span class="s">&#39;package_update&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">name</span> <span class="p">}):</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Not authorized to see this page&#39;</span><span class="p">))</span>
            <span class="n">h</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;role&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">pkg</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="s">&#39;package_show&#39;</span><span class="p">)(</span><span class="n">context</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">pkg</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">username</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;role&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">role</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="s">&#39;dataset_editor_add&#39;</span><span class="p">)(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_success</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;message&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">NotAuthorized</span><span class="p">:</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;No sufficient privileges to add a user to role </span><span class="si">%s</span><span class="s">.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">role</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;User not found&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">email</span><span class="p">:</span>

            <span class="n">EMAIL_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    ^[\w\d!#$%&amp;\&#39;\*\+\-/=\?\^`{\|\}~]</span>
<span class="sd">    [\w\d!#$%&amp;\&#39;\*\+\-/=\?\^`{\|\}~.]+</span>
<span class="sd">    @</span>
<span class="sd">    [a-z.A-Z0-9-]+</span>
<span class="sd">    \.</span>
<span class="sd">    [a-zA-Z]{2,6}$</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">email</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">EMAIL_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">asbool</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;kata.invitations&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">))):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">asbool</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;kata.invitations&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">))):</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">u&#39;Feature disabled&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">u&#39;Invalid email address&#39;</span><span class="p">)</span>
                    <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">captcha</span><span class="o">.</span><span class="n">check_recaptcha</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">subject</span> <span class="o">=</span> <span class="s">u&#39;Invitation to use the Etsin - kutsu käyttämään Etsin-palvelua&#39;</span>
                            <span class="n">body</span> <span class="o">=</span> <span class="s">u&#39;</span><span class="se">\n\n</span><span class="si">%s</span><span class="s"> would like to add you as an editor for dataset &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="se">\</span>
<span class="s">in the Etsin data search service. To enable this, please log in to the service: </span><span class="si">%s</span><span class="s">.</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">site_url</span><span class="p">)</span>
                            <span class="n">body</span> <span class="o">+=</span> <span class="s">u&#39;</span><span class="se">\n\n</span><span class="si">%s</span><span class="s"> haluaisi lisätä sinut muokkaajaksi tietoaineistoon &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="se">\</span>
<span class="s">Etsin-hakupalvelussa. Mahdollistaaksesi tämän, ole hyvä ja kirjaudu palveluun osoitteessa: </span><span class="si">%s</span><span class="s">.</span><span class="se">\n\n</span><span class="s">&#39;</span> \
                                    <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">site_url</span><span class="p">)</span>
                            <span class="n">body</span> <span class="o">+=</span> <span class="s">u&#39;</span><span class="se">\n</span><span class="s">------------</span><span class="se">\n</span><span class="s">Lähettäjän viesti / Sender</span><span class="se">\&#39;</span><span class="s">s message:</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">------------</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;mail_message&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>

                            <span class="n">ckan</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">mailer</span><span class="o">.</span><span class="n">mail_recipient</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
                            <span class="n">h</span><span class="o">.</span><span class="n">flash_success</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Message sent&#39;</span><span class="p">))</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Invitation sent by </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
                        <span class="k">except</span> <span class="n">ckan</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">mailer</span><span class="o">.</span><span class="n">MailerException</span><span class="p">:</span>
                            <span class="k">raise</span>
                    <span class="k">except</span> <span class="n">captcha</span><span class="o">.</span><span class="n">CaptchaError</span><span class="p">:</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">u&#39;Bad Captcha. Please try again.&#39;</span><span class="p">)</span>
                        <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;domain_object&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">id</span>
        <span class="n">domain_object_ref</span> <span class="o">=</span> <span class="n">_get_or_bust</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="s">&#39;domain_object&#39;</span><span class="p">)</span>
        <span class="c"># domain_object_ref is actually pkg.id, so this could be simplified</span>
        <span class="n">domain_object</span> <span class="o">=</span> <span class="n">ckan</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">get_domain_object</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">domain_object_ref</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_dataset_role_page</span><span class="p">(</span><span class="n">domain_object</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KataPackageController.dataset_editor_delete"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KataPackageController.dataset_editor_delete">[docs]</a>    <span class="k">def</span> <span class="nf">dataset_editor_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Deletes a user from a dataset role.</span>

<span class="sd">        :param name: dataset name</span>
<span class="sd">        :type name: string</span>
<span class="sd">        :param username: user (request.param) and role (request.param) to be deleted from dataset</span>
<span class="sd">        :type username: string</span>
<span class="sd">        :param role: user (request.param) and role (request.param) to be deleted from dataset</span>
<span class="sd">        :type role: string</span>

<span class="sd">        redirects to dataset_editor_manage.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span><span class="p">}</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;role&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;role&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">ckan</span><span class="o">.</span><span class="n">logic</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="s">&#39;dataset_editor_delete&#39;</span><span class="p">)(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_success</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">error_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;message&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">NotAuthorized</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;No sufficient privileges to remove user from role </span><span class="si">%s</span><span class="s">.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;role&#39;</span><span class="p">]</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
            <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;User not found&#39;</span><span class="p">))</span>

        <span class="n">h</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;ckanext.kata.controllers:KataPackageController&#39;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&#39;dataset_editor_manage&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_roles_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userobj</span><span class="p">,</span> <span class="n">domain_object</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Builds the selection of roles for the role popup menu</span>

<span class="sd">        :param userobj: user object</span>
<span class="sd">        :param domain_object: dataset domain object</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ckan</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">authz</span><span class="o">.</span><span class="n">user_has_role</span><span class="p">(</span><span class="n">userobj</span><span class="p">,</span> <span class="s">&#39;admin&#39;</span><span class="p">,</span> <span class="n">domain_object</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="n">userobj</span><span class="o">.</span><span class="n">sysadmin</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[{</span><span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="s">&#39;Admin&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="s">&#39;admin&#39;</span><span class="p">},</span>
                    <span class="p">{</span><span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="s">&#39;Editor&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="s">&#39;editor&#39;</span><span class="p">},</span>
                    <span class="p">{</span><span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="s">&#39;Reader&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="s">&#39;reader&#39;</span><span class="p">}]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[{</span><span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="s">&#39;Editor&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="s">&#39;editor&#39;</span><span class="p">},</span>
                    <span class="p">{</span><span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="s">&#39;Reader&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="s">&#39;reader&#39;</span><span class="p">}]</span>

    <span class="k">def</span> <span class="nf">_show_dataset_role_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain_object</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Adds data for template and renders it</span>

<span class="sd">        :param domain_object: dataset domain object</span>
<span class="sd">        :param context: context</span>
<span class="sd">        :param data_dict: data dictionary</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roles_list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">userobj</span><span class="p">,</span> <span class="n">domain_object</span><span class="p">)</span>

        <span class="n">editor_list</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="s">&#39;roles_show&#39;</span><span class="p">)(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">members</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">editor_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;roles&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>\
                <span class="nb">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">role</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

            <span class="n">c</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">],</span> <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">[</span><span class="s">&#39;role&#39;</span><span class="p">]})</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pkg</span> <span class="o">=</span> <span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pkg_dict</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="s">&#39;package_show&#39;</span><span class="p">)(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;package/package_rights.html&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_upload_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">error_summary</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Allow filling dataset form by parsing a user uploaded metadata file.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span>
                   <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">user</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">author</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">check_access</span><span class="p">(</span><span class="s">&#39;package_create&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">t</span><span class="o">.</span><span class="n">NotAuthorized</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Unauthorized to upload metadata&#39;</span><span class="p">))</span>

        <span class="n">xmlfile</span> <span class="o">=</span> <span class="s">u&#39;&#39;</span>
        <span class="n">field_storage</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;xmlfile&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_storage</span><span class="p">,</span> <span class="n">FieldStorage</span><span class="p">):</span>
            <span class="n">bffr</span> <span class="o">=</span> <span class="n">field_storage</span><span class="o">.</span><span class="n">file</span>
            <span class="n">xmlfile</span> <span class="o">=</span> <span class="n">bffr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">,</span> <span class="s">u&#39;&#39;</span><span class="p">)</span>
        <span class="n">xmltype</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;format&#39;</span><span class="p">,</span> <span class="s">u&#39;&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Importing from {src}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">src</span><span class="o">=</span><span class="s">&#39;file: &#39;</span> <span class="o">+</span> <span class="n">field_storage</span><span class="o">.</span><span class="n">filename</span> <span class="k">if</span> <span class="n">field_storage</span> <span class="k">else</span> <span class="s">&#39;url: &#39;</span> <span class="o">+</span> <span class="n">url</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">harvester</span> <span class="ow">in</span> <span class="n">plugins</span><span class="o">.</span><span class="n">PluginImplementations</span><span class="p">(</span><span class="n">h_interfaces</span><span class="o">.</span><span class="n">IHarvester</span><span class="p">):</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">harvester</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span> <span class="ow">or</span> <span class="s">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Harvester </span><span class="si">%r</span><span class="s"> does not provide the harvester name in the info response&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">harvester</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">xmltype</span> <span class="o">==</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_upload_xml: Found harvester for import: {nam}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nam</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># TODO: virus check ??</span>
                    <span class="k">if</span> <span class="n">xmlfile</span><span class="p">:</span>
                        <span class="n">pkg_dict</span> <span class="o">=</span> <span class="n">harvester</span><span class="o">.</span><span class="n">parse_xml</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">url</span><span class="p">:</span>
                        <span class="n">pkg_dict</span> <span class="o">=</span> <span class="n">harvester</span><span class="o">.</span><span class="n">fetch_xml</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Give upload URL or file.&#39;</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">KataPackageController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">pkg_dict</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">error_summary</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">URLError</span><span class="p">,</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Could not fetch from url {ur}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ur</span><span class="o">=</span><span class="n">url</span><span class="p">))</span>
                    <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Could not fetch from url {ur}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ur</span><span class="o">=</span><span class="n">url</span><span class="p">)))</span>
                    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">h</span><span class="o">.</span><span class="n">flash_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Invalid upload URL&#39;</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">redirect_to</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="s">&#39;package&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;new&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="KataPackageController.new"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KataPackageController.new">[docs]</a>    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">error_summary</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Overwrite CKAN method to take uploading xml into sequence.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;upload&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_xml</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">error_summary</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">KataPackageController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">error_summary</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="KataInfoController"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KataInfoController">[docs]</a><span class="k">class</span> <span class="nc">KataInfoController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    KataInfoController provides info pages, which</span>
<span class="sd">    are non-dynamic and visible for all</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="KataInfoController.render_help"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KataInfoController.render_help">[docs]</a>    <span class="k">def</span> <span class="nf">render_help</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Provides the help page</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;kata/help.html&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KataInfoController.render_faq"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.KataInfoController.render_faq">[docs]</a>    <span class="k">def</span> <span class="nf">render_faq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Provides the FAQ page</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;kata/faq.html&#39;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="MalwareScanningStorageController"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.MalwareScanningStorageController">[docs]</a><span class="k">class</span> <span class="nc">MalwareScanningStorageController</span><span class="p">(</span><span class="n">StorageController</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MalwareScanningStorageController extends the standard CKAN StorageController</span>
<span class="sd">    class by adding an optional malware check on file uploads.</span>

<span class="sd">    Malware scanning is disabled by default but can be enabled by setting</span>
<span class="sd">    the configuration option kata.storage.malware_scan to true.</span>
<span class="sd">    When scanning is enabled, not having a ClamAV daemon running</span>
<span class="sd">    will cause uploads to be rejected.</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="MalwareScanningStorageController.upload_handle"><a class="viewcode-back" href="../../../ckanext.kata.html#ckanext.kata.controllers.MalwareScanningStorageController.upload_handle">[docs]</a>    <span class="k">def</span> <span class="nf">upload_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">field_storage</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;file&#39;</span><span class="p">)</span>
        <span class="nb">buffer</span> <span class="o">=</span> <span class="n">field_storage</span><span class="o">.</span><span class="n">file</span>

        <span class="n">do_scan</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;kata.storage.malware_scan&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_scan</span><span class="p">:</span>
            <span class="n">passed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">passed</span> <span class="o">=</span> <span class="n">clamd_wrapper</span><span class="o">.</span><span class="n">scan_for_malware</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
                <span class="c"># reset the stream so that the data can be properly read again</span>
                <span class="nb">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">clamd_wrapper</span><span class="o">.</span><span class="n">MalwareCheckError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">passed</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">passed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">StorageController</span><span class="o">.</span><span class="n">upload_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># TODO: produce a meaningful error message through javascript?</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="simple">
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="../../../search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="../../../genindex.html" title="General Index"
             >index</a>
        </div>

        <div class="right">
          
    <div class="footer">
        &copy; Copyright 2014, CSC.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>